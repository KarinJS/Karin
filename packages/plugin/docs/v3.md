# Karin Plugin Spec v3

> 本规范定义 karinjs 插件的**结构、生命周期、执行模型与开发体验**。
> v3 重点：**区分生产环境与开发环境，提供差异化的热更新策略**。
(,)
---

## 一、核心设计原则

1. **插件是声明式的，而不是继承式的**
2. **能力通过组合获得，而不是配置堆叠**
3. **核心稳定，扩展自由**
4. **函数优先，class 仅作为实现细节**
5. **插件之间不直接耦合**
6. **包是分发单元，插件是执行单元**
7. **开发体验与生产性能同等重要** _(v3 新增)_

---

## 二、环境模型 _(v3 新增)_

### 2.1 两种插件来源

```
┌─────────────────────────────────────────────────────────────┐
│                      Karin Runtime                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────┐    ┌─────────────────────────┐    │
│  │   NPM Packages      │    │   Local Plugins         │    │
│  │   (node_modules)    │    │   (plugins/)            │    │
│  ├─────────────────────┤    ├─────────────────────────┤    │
│  │ • 已发布的稳定包     │    │ • 本地开发的插件         │    │
│  │ • 无需热更新         │    │ • 需要热更新             │    │
│  │ • 静态加载          │    │ • 动态加载               │    │
│  │ • 版本锁定          │    │ • 实时生效               │    │
│  └─────────────────────┘    └─────────────────────────┘    │
│            │                          │                     │
│            ▼                          ▼                     │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Unified Plugin Registry                 │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 环境定义

```ts
export type PluginEnvironment = 'production' | 'development'

export interface PluginSource {
  /** 插件来源类型 */
  type: 'npm' | 'local'

  /** 来源路径 */
  path: string

  /** 是否支持热更新 */
  hotReload: boolean

  /** 热更新策略 */
  hotReloadStrategy?: HotReloadStrategy
}

export type HotReloadStrategy =
  | 'none'           // 不支持热更新（npm 包）
  | 'url-param'      // URL 参数方式（plugins 目录）
  | 'cache-clear'    // 缓存清理方式（开发环境）
```

---

## 三、目录结构约定 _(v3 新增)_

### 3.1 标准项目结构

```
project/
├── package.json
├── karin.config.ts          # 框架配置
├── node_modules/
│   ├── @karin/core
│   ├── karin-plugin-xxx     # NPM 插件包（生产环境）
│   └── ...
├── plugins/                  # 本地插件目录（热更新）
│   ├── my-plugin/
│   │   ├── index.ts
│   │   ├── commands/
│   │   │   ├── ping.ts
│   │   │   └── help.ts
│   │   └── handlers/
│   │       └── welcome.ts
│   ├── another-plugin/
│   │   └── index.ts
│   └── simple.ts            # 单文件插件
└── data/                     # 数据目录
    └── ...
```

### 3.2 加载规则

| 来源 | 路径模式 | 热更新 | 加载方式 |
|------|----------|--------|----------|
| NPM 包 | `node_modules/karin-plugin-*` | ❌ | 静态 import |
| NPM 包 | `node_modules/@*/karin-plugin-*` | ❌ | 静态 import |
| 本地插件 | `plugins/**/*.{js,ts}` | ✅ | 动态 import |
| 开发包 | `packages/*/src/**/*.ts` | ✅ | 缓存清理 |

---

## 四、热更新系统 _(v3 核心)_

### 4.1 热更新策略对比

```
┌─────────────────────────────────────────────────────────────┐
│                    Hot Reload Strategies                     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Strategy: none (NPM Packages)                       │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │  • 静态导入，启动时加载                               │   │
│  │  • 更新需要重启进程                                   │   │
│  │  • 最高性能，零运行时开销                             │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Strategy: url-param (plugins/ directory)            │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │  • 动态导入 + URL 时间戳参数                          │   │
│  │  • import(`./plugin.js?t=${Date.now()}`)             │   │
│  │  • 文件变更自动重载                                   │   │
│  │  • 适用于生产环境的本地插件                           │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Strategy: cache-clear (Development Mode)            │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │  • 通过 CLI 启动，启用 Node 内部 API                  │   │
│  │  • 清理模块缓存 + 依赖树                              │   │
│  │  • 支持 TypeScript 直接运行                          │   │
│  │  • 完整的 HMR 体验                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 URL 参数热更新（plugins 目录）

```ts
/**
 * plugins 目录的热更新实现
 * 通过 URL 查询参数绕过 ESM 缓存
 */
export interface UrlParamHotReload {
  /**
   * 加载插件
   * @param filePath 文件路径
   */
  load(filePath: string): Promise<Package>

  /**
   * 重载插件
   * @param filePath 文件路径
   */
  reload(filePath: string): Promise<Package>

  /**
   * 卸载插件
   * @param filePath 文件路径
   */
  unload(filePath: string): Promise<void>
}

// 内部实现示意
async function loadWithUrlParam(filePath: string): Promise<unknown> {
  const fileUrl = pathToFileURL(filePath).href
  const urlWithTimestamp = `${fileUrl}?t=${Date.now()}`
  return import(urlWithTimestamp)
}
```

### 4.3 缓存清理热更新（开发环境）

```ts
/**
 * 开发环境的热更新实现
 * 需要通过 karin CLI 启动以启用 Node 内部 API
 */
export interface CacheClearHotReload {
  /**
   * 清理模块缓存
   * @param modulePath 模块路径
   */
  clearCache(modulePath: string): void

  /**
   * 清理模块及其依赖树
   * @param modulePath 模块路径
   */
  clearWithDependencies(modulePath: string): void

  /**
   * 重载模块
   * @param modulePath 模块路径
   */
  reload(modulePath: string): Promise<unknown>

  /**
   * 获取模块依赖树
   * @param modulePath 模块路径
   */
  getDependencyTree(modulePath: string): string[]
}

// CLI 启动命令
// karin dev --hot
// 内部启用: --experimental-vm-modules --expose-internals
```

### 4.4 文件监听配置

```ts
export interface WatcherConfig {
  /** 监听的目录 */
  paths: string[]

  /** 忽略的模式 */
  ignored?: string[]

  /** 防抖延迟（ms） */
  debounce?: number

  /** 是否递归监听 */
  recursive?: boolean

  /** 文件变更回调 */
  onChange?: (event: WatchEvent) => void
}

export interface WatchEvent {
  type: 'add' | 'change' | 'unlink'
  path: string
  timestamp: number
}
```

---

## 五、基础抽象

### 5.1 Context

```ts
export type Context = unknown
```

Context 是事件载体，由适配器生成，插件**只能通过公开 API 访问**。

### 5.2 Middleware

```ts
export type Middleware<TCtx = Context> = (
  ctx: TCtx,
  next: () => Promise<void>
) => Promise<void>
```

### 5.3 Plugin

```ts
export interface Plugin<TCtx = Context> {
  /** 插件唯一标识（包内唯一） */
  id: string

  /** 插件名称 */
  name?: string

  /** 插件事件域 */
  kind: PluginKind

  /** 事件匹配 + 类型收窄 */
  match: (ctx: Context) => ctx is TCtx

  /** 中间件链 */
  middlewares?: Middleware<TCtx>[]

  /** 最终处理器 */
  handler?: Middleware<TCtx>

  /** 执行优先级（数值越小越先执行，默认 10000） */
  priority?: number

  /** 插件级生命周期钩子 */
  lifecycle?: PluginLifecycle

  /** 是否启用（默认 true） */
  enabled?: boolean

  /** 插件级元信息 */
  meta?: PluginMeta
}

export type PluginKind = 'message' | 'notice' | 'request' | 'any'
```

### 5.4 Package

```ts
export interface Package {
  /** 包唯一标识 */
  id: string

  /** 包名称 */
  name: string

  /** 包版本 */
  version: string

  /** 包含的插件列表 */
  plugins: Plugin[]

  /** 包级生命周期钩子 */
  lifecycle?: PackageLifecycle

  /** 包级配置 schema */
  configSchema?: ConfigSchema

  /** 包元信息 */
  meta?: PackageMeta

  /** 依赖的其他包 */
  dependencies?: PackageDependency[]

  /** 导出的公共 API */
  exports?: Record<string, unknown>

  /** 热更新配置（仅本地插件有效） */
  hot?: HotConfig
}
```

---

## 六、热更新配置 _(v3 新增)_

### 6.1 HotConfig

```ts
export interface HotConfig {
  /** 是否启用热更新（默认根据来源自动判断） */
  enabled?: boolean

  /** 热更新策略 */
  strategy?: HotReloadStrategy

  /** 需要保留的状态 key */
  preserveState?: string[]

  /** 重载前回调 */
  beforeReload?: () => Promise<void> | void

  /** 重载后回调 */
  afterReload?: () => Promise<void> | void

  /** 自定义清理逻辑 */
  cleanup?: () => Promise<void> | void
}
```

### 6.2 热更新生命周期

```ts
export interface HotLifecycle {
  /** 即将热更新 */
  onHotReload?(ctx: HotReloadContext): Promise<void> | void

  /** 热更新完成 */
  onHotReloaded?(ctx: HotReloadContext): Promise<void> | void

  /** 热更新失败 */
  onHotReloadError?(ctx: HotReloadContext, error: Error): Promise<void> | void
}

export interface HotReloadContext {
  /** 包 ID */
  packageId: string

  /** 触发热更新的文件 */
  changedFile: string

  /** 变更类型 */
  changeType: 'add' | 'change' | 'unlink'

  /** 旧模块（如果有） */
  oldModule?: Package

  /** 状态存储（用于跨热更新保留状态） */
  state: Map<string, unknown>
}
```

### 6.3 状态保留

```ts
// 使用示例：保留跨热更新的状态
let counter = 0

export default definePackage({
  id: 'stateful-plugin',
  name: 'Stateful Plugin',
  version: '1.0.0',

  hot: {
    preserveState: ['counter'],
    beforeReload() {
      // 保存状态到 hot context
      return { counter }
    },
    afterReload(preserved) {
      // 恢复状态
      counter = preserved?.counter ?? 0
    }
  },

  plugins: [
    definePlugin({
      id: 'counter',
      kind: 'message',
      match: isMessage,
      handler: ctx => {
        counter++
        ctx.reply(`Count: ${counter}`)
      }
    })
  ]
})
```

---

## 七、定义函数

### 7.1 definePlugin

```ts
export function definePlugin<TCtx = Context>(
  plugin: Plugin<TCtx>
): Plugin<TCtx>
```

### 7.2 definePackage

```ts
export function definePackage(pkg: Package): Package
```

### 7.3 createPluginFactory

```ts
export function createPluginFactory<TOptions, TCtx = Context>(
  factory: (options: TOptions) => Plugin<TCtx>
): (options: TOptions) => Plugin<TCtx>
```

---

## 八、生命周期系统

### 8.1 PackageLifecycle

```ts
export interface PackageLifecycle extends HotLifecycle {
  /** 包加载时 */
  onLoad?(ctx: PackageLifecycleContext): Promise<void> | void

  /** 包就绪时 */
  onReady?(ctx: PackageLifecycleContext): Promise<void> | void

  /** 包卸载时 */
  onUnload?(ctx: PackageLifecycleContext): Promise<void> | void

  /** 配置变更时 */
  onConfigChange?(ctx: PackageLifecycleContext, config: unknown): Promise<void> | void
}
```

### 8.2 PluginLifecycle

```ts
export interface PluginLifecycle {
  /** 插件加载时 */
  onLoad?(ctx: PluginLifecycleContext): Promise<void> | void

  /** 插件卸载时 */
  onUnload?(ctx: PluginLifecycleContext): Promise<void> | void

  /** 插件启用时 */
  onEnable?(ctx: PluginLifecycleContext): Promise<void> | void

  /** 插件禁用时 */
  onDisable?(ctx: PluginLifecycleContext): Promise<void> | void
}
```

### 8.3 LifecycleContext

```ts
export interface BaseLifecycleContext {
  /** 日志器 */
  logger: Logger

  /** 注册清理函数 */
  dispose(fn: () => void | Promise<void>): void

  /** 获取其他包的导出 */
  getExports<T = unknown>(packageId: string): T | undefined

  /** 当前环境 */
  env: PluginEnvironment

  /** 插件来源信息 */
  source: PluginSource
}

export interface PackageLifecycleContext extends BaseLifecycleContext {
  packageId: string
  config: ConfigAccessor
  plugins: Plugin[]
}

export interface PluginLifecycleContext extends BaseLifecycleContext {
  pluginId: string
  packageId: string
  config: ConfigAccessor
}
```

### 8.4 生命周期执行顺序

```
[正常加载]
Package.onLoad
    ↓
Plugin[0].onLoad → Plugin[1].onLoad → ...
    ↓
Package.onReady

[热更新]
Package.onHotReload (旧)
    ↓
Plugin[n].onUnload → ... → Plugin[0].onUnload (旧)
    ↓
Package.onUnload (旧)
    ↓
[加载新模块]
    ↓
Package.onLoad (新)
    ↓
Plugin[0].onLoad → Plugin[1].onLoad → ... (新)
    ↓
Package.onReady (新)
    ↓
Package.onHotReloaded (新)

[卸载]
Plugin[n].onUnload → ... → Plugin[0].onUnload
    ↓
Package.onUnload
```

---

## 九、CLI 工具 _(v3 新增)_

### 9.1 命令概览

```bash
# 生产模式启动
karin start

# 开发模式启动（启用完整热更新）
karin dev

# 开发模式 + 指定监听目录
karin dev --watch plugins,packages

# 仅监听 plugins 目录（URL 参数热更新）
karin start --hot-plugins

# 查看插件列表
karin plugins list

# 安装插件
karin plugins install karin-plugin-xxx

# 创建新插件
karin create plugin my-plugin
```

### 9.2 开发模式实现

```ts
// CLI 内部实现
import { spawn } from 'child_process'

function startDevMode(options: DevOptions) {
  const nodeArgs = [
    // 启用 ESM loader
    '--loader', '@karin/dev-loader',
    // 启用实验性 VM 模块（用于缓存清理）
    '--experimental-vm-modules',
    // 暴露内部 API（用于访问模块缓存）
    '--expose-internals',
    // 入口文件
    'node_modules/@karin/core/dist/cli.js',
    'dev',
    ...options.args
  ]

  spawn('node', nodeArgs, {
    stdio: 'inherit',
    env: {
      ...process.env,
      KARIN_DEV: 'true',
      KARIN_HOT: 'true'
    }
  })
}
```

### 9.3 开发加载器

```ts
// @karin/dev-loader
import { resolve as resolveTs } from 'ts-node/esm'
import { ModuleCache } from './module-cache'

const cache = new ModuleCache()

export async function resolve(specifier, context, nextResolve) {
  // 处理 TypeScript
  if (specifier.endsWith('.ts')) {
    return resolveTs(specifier, context, nextResolve)
  }
  return nextResolve(specifier, context)
}

export async function load(url, context, nextLoad) {
  // 记录模块依赖关系
  cache.recordDependency(context.parentURL, url)
  return nextLoad(url, context)
}

// 暴露缓存清理 API
export function clearModuleCache(modulePath: string) {
  cache.clearWithDependencies(modulePath)
}
```

---

## 十、插件执行模型

### 10.1 执行流程

```
收到事件 ctx
    ↓
按 priority 排序所有已启用插件
    ↓
┌─ Plugin A ────────────────────────┐
│  match(ctx) → true                │
│      ↓                            │
│  middlewares[0](ctx, next)        │
│      ↓ next()                     │
│  middlewares[1](ctx, next)        │
│      ↓ next()                     │
│  handler(ctx, next)               │
│      ↓ next()                     │
└───────────────────────────────────┘
    ↓
┌─ Plugin B ────────────────────────┐
│  match(ctx) → true                │
│  handler(ctx, next)               │
│      ↓ 不调用 next() (终止)        │
└───────────────────────────────────┘
```

### 10.2 优先级规则

```ts
const PRIORITY = {
  SYSTEM: 0,        // 系统级
  HIGHEST: 1000,    // 最高
  HIGH: 5000,       // 高
  NORMAL: 10000,    // 正常（默认）
  LOW: 15000,       // 低
  LOWEST: 20000     // 最低
}
```

---

## 十一、事件系统

### 11.1 EventDescriptor

```ts
export interface EventDescriptor<TCtx = Context> {
  kind: PluginKind
  match: (ctx: Context) => ctx is TCtx
}
```

### 11.2 官方事件集合

```ts
export const Message = {
  any: { kind: 'message', match: isMessage },
  group: { kind: 'message', match: isGroupMessage },
  private: { kind: 'message', match: isPrivateMessage },
  guild: { kind: 'message', match: isGuildMessage }
} as const

export const Notice = {
  any: { kind: 'notice', match: isNotice },
  groupIncrease: { kind: 'notice', match: isGroupIncrease },
  groupDecrease: { kind: 'notice', match: isGroupDecrease }
} as const

export const Request = {
  any: { kind: 'request', match: isRequest },
  friend: { kind: 'request', match: isFriendRequest },
  group: { kind: 'request', match: isGroupRequest }
} as const
```

---

## 十二、配置系统

### 12.1 ConfigSchema

```ts
export interface ConfigSchema {
  schema: JSONSchema
  defaults?: Record<string, unknown>
  migrations?: ConfigMigration[]
}

export interface ConfigMigration {
  from: string
  to: string
  migrate: (config: unknown) => unknown
}
```

### 12.2 ConfigAccessor

```ts
export interface ConfigAccessor<T = unknown> {
  get(): T
  get<K extends keyof T>(key: K): T[K]
  set(value: Partial<T>): void
  set<K extends keyof T>(key: K, value: T[K]): void
  reset(): void
  onChange(handler: (newValue: T, oldValue: T) => void): () => void
}
```

---

## 十三、元信息规范

### 13.1 PackageMeta

```ts
export interface PackageMeta {
  description?: string
  author?: string | AuthorInfo
  homepage?: string
  repository?: string
  license?: string
  tags?: string[]
  icon?: string
  engines?: { karin?: string }
  adapters?: string[]
  official?: boolean
  deprecated?: string | boolean
}
```

### 13.2 PluginMeta

```ts
export interface PluginMeta {
  description?: string
  usage?: string | string[]
  permissions?: string[]
  hidden?: boolean
  deprecated?: string | boolean
}
```

---

## 十四、包依赖系统

### 14.1 PackageDependency

```ts
export interface PackageDependency {
  id: string
  version?: string
  optional?: boolean
}
```

### 14.2 导出与引用

```ts
// 包 A 导出 API
definePackage({
  id: 'database',
  exports: {
    query: (sql: string) => db.query(sql),
    getConnection: () => connection
  }
})

// 包 B 使用
lifecycle: {
  onLoad(ctx) {
    const db = ctx.getExports('database')
    db?.query('SELECT 1')
  }
}
```

---

## 十五、Command Builder

### 15.1 基础用法

```ts
import { command } from '@karin/plugin'

command('ping')
  .handler(ctx => ctx.reply('pong'))

command('echo <message>')
  .handler((ctx, { message }) => ctx.reply(message))

command('ban <user> [duration]')
  .alias('封禁')
  .description('封禁用户')
  .permission('admin')
  .use(auth({ level: 'admin' }))
  .handler(async (ctx, { user, duration }) => {
    await banUser(user, duration)
    ctx.reply(`已封禁 ${user}`)
  })
```

---

## 十六、完整示例

### 16.1 NPM 包插件（生产环境）

```ts
// karin-plugin-toolkit/src/index.ts
import { definePackage, definePlugin, Message } from '@karin/plugin'

export default definePackage({
  id: 'karin-plugin-toolkit',
  name: '工具箱',
  version: '1.0.0',

  plugins: [
    definePlugin({
      id: 'ping',
      kind: 'message',
      match: Message.any.match,
      handler: ctx => ctx.reply('pong')
    }),

    definePlugin({
      id: 'time',
      kind: 'message',
      match: Message.any.match,
      handler: ctx => ctx.reply(new Date().toLocaleString())
    })
  ],

  meta: {
    description: '常用工具集合',
    author: 'Karin Team',
    license: 'MIT'
  }

  // 无需 hot 配置，NPM 包不支持热更新
})
```

### 16.2 本地插件（plugins 目录，URL 参数热更新）

```ts
// plugins/my-tools/index.ts
import { definePackage, definePlugin, Message } from '@karin/plugin'

let callCount = 0

export default definePackage({
  id: 'my-tools',
  name: '我的工具',
  version: '0.1.0',

  hot: {
    // 保留状态
    preserveState: ['callCount'],
    beforeReload: () => ({ callCount }),
    afterReload: (state) => { callCount = state?.callCount ?? 0 }
  },

  plugins: [
    definePlugin({
      id: 'counter',
      kind: 'message',
      match: Message.any.match,
      handler: ctx => {
        callCount++
        ctx.reply(`调用次数: ${callCount}`)
      }
    })
  ],

  lifecycle: {
    onHotReloaded(ctx) {
      ctx.logger.info(`热更新完成，状态已恢复`)
    }
  }
})
```

### 16.3 开发环境插件包

```ts
// packages/my-dev-plugin/src/index.ts
import { definePackage, definePlugin, command } from '@karin/plugin'

export default definePackage({
  id: 'my-dev-plugin',
  name: '开发中的插件',
  version: '0.0.1',

  hot: {
    // 开发环境使用缓存清理策略
    strategy: 'cache-clear',
    // 清理自定义资源
    cleanup: async () => {
      await closeDatabase()
      clearInterval(heartbeatTimer)
    }
  },

  plugins: [
    command('test')
      .handler(ctx => ctx.reply('开发测试中...')),

    definePlugin({
      id: 'dev-logger',
      kind: 'any',
      match: () => true,
      priority: 0,
      handler: async (ctx, next) => {
        console.log('[DEV]', ctx)
        await next()
      }
    })
  ],

  lifecycle: {
    onLoad(ctx) {
      ctx.logger.info(`开发模式: ${ctx.env === 'development'}`)
      ctx.logger.info(`来源: ${ctx.source.type}`)
    }
  }
})
```

### 16.4 单文件插件

```ts
// plugins/simple-reply.ts
import { definePackage, definePlugin, Message } from '@karin/plugin'

export default definePackage({
  id: 'simple-reply',
  name: '简单回复',
  version: '1.0.0',
  plugins: [
    definePlugin({
      id: 'main',
      kind: 'message',
      match: Message.any.match,
      handler: async ctx => {
        if (ctx.message.text === '你好') {
          await ctx.reply('你好呀！')
        }
      }
    })
  ]
})
```

---

## 十七、禁止行为

| ❌ 禁止 | 说明 |
|--------|------|
| 强制使用 class | class 是实现细节 |
| 插件访问框架内部实例 | 只能通过公开 API |
| 修改 ctx 原型 | 会影响其他插件 |
| 依赖插件加载顺序 | 使用 priority |
| 在 match 中产生副作用 | match 必须是纯函数 |
| 直接修改其他包的状态 | 通过 exports API |
| 在热更新时不清理资源 | 会导致内存泄漏 |
| NPM 包假设热更新可用 | NPM 包不支持热更新 |

---

## 十八、类型定义汇总

```ts
// ============ 环境相关 ============
export type PluginEnvironment = 'production' | 'development'

export type HotReloadStrategy = 'none' | 'url-param' | 'cache-clear'

export interface PluginSource {
  type: 'npm' | 'local'
  path: string
  hotReload: boolean
  hotReloadStrategy?: HotReloadStrategy
}

// ============ 核心类型 ============
export type Context = unknown

export type PluginKind = 'message' | 'notice' | 'request' | 'any'

export type Middleware<TCtx = Context> = (
  ctx: TCtx,
  next: () => Promise<void>
) => Promise<void>

export interface Plugin<TCtx = Context> {
  id: string
  name?: string
  kind: PluginKind
  match: (ctx: Context) => ctx is TCtx
  middlewares?: Middleware<TCtx>[]
  handler?: Middleware<TCtx>
  priority?: number
  lifecycle?: PluginLifecycle
  enabled?: boolean
  meta?: PluginMeta
}

export interface Package {
  id: string
  name: string
  version: string
  plugins: Plugin[]
  lifecycle?: PackageLifecycle
  configSchema?: ConfigSchema
  meta?: PackageMeta
  dependencies?: PackageDependency[]
  exports?: Record<string, unknown>
  hot?: HotConfig
}

// ============ 热更新相关 ============
export interface HotConfig {
  enabled?: boolean
  strategy?: HotReloadStrategy
  preserveState?: string[]
  beforeReload?: () => Promise<unknown> | unknown
  afterReload?: (preserved?: unknown) => Promise<void> | void
  cleanup?: () => Promise<void> | void
}

export interface HotReloadContext {
  packageId: string
  changedFile: string
  changeType: 'add' | 'change' | 'unlink'
  oldModule?: Package
  state: Map<string, unknown>
}

export interface HotLifecycle {
  onHotReload?(ctx: HotReloadContext): Promise<void> | void
  onHotReloaded?(ctx: HotReloadContext): Promise<void> | void
  onHotReloadError?(ctx: HotReloadContext, error: Error): Promise<void> | void
}

// ============ 生命周期 ============
export interface PluginLifecycle {
  onLoad?(ctx: PluginLifecycleContext): Promise<void> | void
  onUnload?(ctx: PluginLifecycleContext): Promise<void> | void
  onEnable?(ctx: PluginLifecycleContext): Promise<void> | void
  onDisable?(ctx: PluginLifecycleContext): Promise<void> | void
}

export interface PackageLifecycle extends HotLifecycle {
  onLoad?(ctx: PackageLifecycleContext): Promise<void> | void
  onReady?(ctx: PackageLifecycleContext): Promise<void> | void
  onUnload?(ctx: PackageLifecycleContext): Promise<void> | void
  onConfigChange?(ctx: PackageLifecycleContext, config: unknown): Promise<void> | void
}

export interface BaseLifecycleContext {
  logger: Logger
  dispose(fn: () => void | Promise<void>): void
  getExports<T = unknown>(packageId: string): T | undefined
  env: PluginEnvironment
  source: PluginSource
}

export interface PackageLifecycleContext extends BaseLifecycleContext {
  packageId: string
  config: ConfigAccessor
  plugins: Plugin[]
}

export interface PluginLifecycleContext extends BaseLifecycleContext {
  pluginId: string
  packageId: string
  config: ConfigAccessor
}

// ============ 配置相关 ============
export interface ConfigSchema {
  schema: JSONSchema
  defaults?: Record<string, unknown>
  migrations?: ConfigMigration[]
}

export interface ConfigMigration {
  from: string
  to: string
  migrate: (config: unknown) => unknown
}

export interface ConfigAccessor<T = unknown> {
  get(): T
  get<K extends keyof T>(key: K): T[K]
  set(value: Partial<T>): void
  set<K extends keyof T>(key: K, value: T[K]): void
  reset(): void
  onChange(handler: (newValue: T, oldValue: T) => void): () => void
}

// ============ 元信息 ============
export interface PluginMeta {
  description?: string
  usage?: string | string[]
  permissions?: string[]
  hidden?: boolean
  deprecated?: string | boolean
}

export interface PackageMeta {
  description?: string
  author?: string | AuthorInfo
  homepage?: string
  repository?: string
  license?: string
  tags?: string[]
  icon?: string
  engines?: { karin?: string }
  adapters?: string[]
  official?: boolean
  deprecated?: string | boolean
}

export interface AuthorInfo {
  name: string
  email?: string
  url?: string
}

export interface PackageDependency {
  id: string
  version?: string
  optional?: boolean
}

// ============ 文件监听 ============
export interface WatcherConfig {
  paths: string[]
  ignored?: string[]
  debounce?: number
  recursive?: boolean
  onChange?: (event: WatchEvent) => void
}

export interface WatchEvent {
  type: 'add' | 'change' | 'unlink'
  path: string
  timestamp: number
}
```

---

## 十九、架构总结

```
┌─────────────────────────────────────────────────────────────┐
│                      Karin Runtime                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌───────────────────────────────────────────────────────┐ │
│  │                   Package Loader                       │ │
│  ├───────────────────────────────────────────────────────┤ │
│  │  NPM Loader          │  Local Loader                  │ │
│  │  • 静态 import       │  • 动态 import + URL param     │ │
│  │  • 无热更新          │  • 文件监听 + 热更新           │ │
│  └───────────────────────────────────────────────────────┘ │
│                            │                                │
│  ┌───────────────────────────────────────────────────────┐ │
│  │                  Plugin Registry                       │ │
│  │  • 统一注册所有来源的插件                              │ │
│  │  • 管理 packageId:pluginId                            │ │
│  │  • 按 priority 排序                                   │ │
│  └───────────────────────────────────────────────────────┘ │
│                            │                                │
│  ┌───────────────────────────────────────────────────────┐ │
│  │                  Event Dispatcher                      │ │
│  │  • 接收 Context                                       │ │
│  │  • 执行 match → middlewares → handler                 │ │
│  └───────────────────────────────────────────────────────┘ │
│                            │                                │
│  ┌───────────────────────────────────────────────────────┐ │
│  │               Hot Reload Manager (Dev)                 │ │
│  │  • 文件监听 (chokidar)                                │ │
│  │  • 模块缓存清理                                       │ │
│  │  • 依赖树分析                                         │ │
│  │  • 状态保留与恢复                                     │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘

开发模式启动: karin dev
  └─ Node.js + --experimental-vm-modules + --expose-internals
       └─ @karin/dev-loader
            └─ 完整 HMR 支持

生产模式启动: karin start
  └─ Node.js (标准模式)
       └─ NPM 包静态加载 + plugins 目录 URL 参数热更新
```

---

> **核心理念：插件规范是"数据 + 函数"的契约。**
> **v3 新增：区分生产与开发环境，提供差异化的热更新策略。**

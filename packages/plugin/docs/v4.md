# Karin Plugin Spec v4

> 本规范定义 karinjs 插件的**结构、生命周期、执行模型与开发体验**。
> v4 重点：**配置驱动、零侵入、灵活的开发模式**。

---

## 一、核心设计原则

1. **插件是声明式的，而不是继承式的**
2. **能力通过组合获得，而不是配置堆叠**
3. **核心稳定，扩展自由**
4. **函数优先，class 仅作为实现细节**
5. **插件之间不直接耦合**
6. **包是分发单元，插件是执行单元**
7. **开发体验与生产性能同等重要**
8. **配置驱动，零侵入，不强制导出约定** _(v4 新增)_

---

## 二、设计哲学 _(v4 新增)_

### 2.1 为什么不强制导出约定？

传统方式要求插件包必须在入口文件导出特定结构：

```ts
// ❌ 传统方式：强制导出约定
// index.ts
export default definePackage({ ... })
```

**问题**：
- 侵入性强，限制了包的结构自由
- 与现有项目集成困难
- 不利于渐进式迁移

**v4 方案**：通过 `karin.config.js` 声明插件位置，框架自动扫描加载：

```ts
// ✅ v4 方式：配置驱动
// karin.config.js
export default {
  plugins: [
    './src/plugins/**/*.ts',
    './src/commands/*.ts'
  ]
}
```

### 2.2 开发环境 vs 运行环境

```
┌─────────────────────────────────────────────────────────────┐
│                     开发环境（根目录）                        │
│                                                             │
│  my-plugin/                    # 插件包根目录                │
│  ├── karin.config.ts           # 开发配置                   │
│  ├── package.json                                          │
│  ├── src/                                                  │
│  │   ├── index.ts              # 包入口（可选，自由定义）    │
│  │   ├── plugins/              # 插件目录                   │
│  │   │   ├── ping.ts                                       │
│  │   │   └── help.ts                                       │
│  │   └── utils/                # 工具目录                   │
│  └── tests/                                                │
│                                                             │
│  开发命令: karin dev                                        │
│  • 监听 karin.config.ts 中定义的文件                        │
│  • 缓存清理热更新                                           │
│  • TypeScript 直接运行                                      │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                     运行环境（用户项目）                      │
│                                                             │
│  user-project/                                              │
│  ├── karin.config.ts           # 用户配置                   │
│  ├── package.json                                          │
│  ├── node_modules/                                         │
│  │   └── karin-plugin-xxx/     # 已安装的 NPM 插件          │
│  │       ├── package.json                                  │
│  │       ├── karin.config.js   # 插件配置（声明插件位置）    │
│  │       └── dist/                                         │
│  ├── plugins/                  # 本地插件（可选）            │
│  │   └── my-local-plugin.ts                                │
│  └── data/                                                 │
│                                                             │
│  生产命令: karin start                                      │
│  • 读取 node_modules 中各包的 karin.config.js               │
│  • 读取 plugins/ 目录                                       │
│  • NPM 包静态加载，plugins/ 支持热更新                      │
└─────────────────────────────────────────────────────────────┘
```

---

## 三、配置系统 _(v4 核心)_

### 3.1 karin.config.ts

```ts
import { defineConfig } from '@karin/core'

export default defineConfig({
  // ============ 插件声明 ============

  /**
   * 插件文件/目录
   * 支持 glob 模式
   */
  plugins: [
    './src/plugins/**/*.ts',
    './src/commands/*.ts',
    './src/handlers/welcome.ts'
  ],

  /**
   * 排除的文件
   */
  exclude: [
    '**/*.test.ts',
    '**/*.spec.ts',
    '**/fixtures/**'
  ],

  // ============ 包信息 ============

  /**
   * 包 ID（默认读取 package.json 的 name）
   */
  id: 'my-plugin',

  /**
   * 包名称
   */
  name: '我的插件',

  /**
   * 包版本（默认读取 package.json 的 version）
   */
  version: '1.0.0',

  // ============ 生命周期 ============

  /**
   * 包级生命周期
   */
  lifecycle: {
    onLoad(ctx) {
      ctx.logger.info('插件包加载')
    },
    onReady(ctx) {
      ctx.logger.info('插件包就绪')
    },
    onUnload(ctx) {
      ctx.logger.info('插件包卸载')
    }
  },

  // ============ 配置 Schema ============

  /**
   * 配置定义
   */
  config: {
    schema: {
      enabled: { type: 'boolean', default: true },
      maxRetry: { type: 'number', default: 3 }
    }
  },

  // ============ 导出 API ============

  /**
   * 导出给其他包使用的 API
   */
  exports: {
    someApi: () => { /* ... */ }
  },

  // ============ 依赖 ============

  /**
   * 依赖的其他插件包
   */
  dependencies: [
    { id: 'database-plugin', version: '^1.0.0' }
  ],

  // ============ 元信息 ============

  meta: {
    description: '一个示例插件',
    author: 'Your Name',
    license: 'MIT',
    tags: ['utility']
  },

  // ============ 热更新 ============

  /**
   * 热更新配置（开发环境）
   */
  hot: {
    /** 需要保留的状态 */
    preserveState: ['counter'],
    /** 清理回调 */
    cleanup: async () => {
      // 清理资源
    }
  }
})
```

### 3.2 defineConfig 类型

```ts
export interface KarinConfig {
  // ============ 插件声明 ============

  /**
   * 插件文件路径（支持 glob）
   * @example ['./src/plugins/**\/*.ts', './src/commands/*.ts']
   */
  plugins: string[]

  /**
   * 排除的文件模式
   */
  exclude?: string[]

  // ============ 包信息 ============

  /**
   * 包 ID（默认从 package.json 读取）
   */
  id?: string

  /**
   * 包显示名称
   */
  name?: string

  /**
   * 包版本（默认从 package.json 读取）
   */
  version?: string

  // ============ 生命周期 ============

  /**
   * 包级生命周期钩子
   */
  lifecycle?: PackageLifecycle

  // ============ 配置 ============

  /**
   * 配置 Schema
   */
  config?: ConfigDefinition

  // ============ 导出 ============

  /**
   * 导出的公共 API
   */
  exports?: Record<string, unknown> | (() => Record<string, unknown>)

  // ============ 依赖 ============

  /**
   * 依赖的其他包
   */
  dependencies?: PackageDependency[]

  // ============ 元信息 ============

  /**
   * 包元信息
   */
  meta?: PackageMeta

  // ============ 热更新 ============

  /**
   * 热更新配置
   */
  hot?: HotConfig
}

export function defineConfig(config: KarinConfig): KarinConfig {
  return config
}
```

### 3.3 配置文件位置

框架按以下顺序查找配置：

```ts
const CONFIG_FILES = [
  'karin.config.ts',
  'karin.config.js',
  'karin.config.mjs',
  'karin.config.cjs'
]
```

---

## 四、插件定义

### 4.1 单文件插件

```ts
// src/plugins/ping.ts
import { definePlugin, Message } from '@karin/core'

export default definePlugin({
  id: 'ping',
  name: 'Ping 命令',
  kind: 'message',
  match: Message.any.match,
  handler: ctx => ctx.reply('pong')
})
```

### 4.2 多插件文件

```ts
// src/plugins/utils.ts
import { definePlugin, Message } from '@karin/core'

// 导出多个插件
export const ping = definePlugin({
  id: 'ping',
  kind: 'message',
  match: Message.any.match,
  handler: ctx => ctx.reply('pong')
})

export const time = definePlugin({
  id: 'time',
  kind: 'message',
  match: Message.any.match,
  handler: ctx => ctx.reply(new Date().toISOString())
})

// 或者导出数组
export default [ping, time]
```

### 4.3 插件工厂

```ts
// src/plugins/auto-reply.ts
import { createPluginFactory, Message } from '@karin/core'

interface AutoReplyOptions {
  trigger: string | RegExp
  response: string
}

const createAutoReply = createPluginFactory<AutoReplyOptions>(
  (options) => ({
    id: `auto-reply:${options.trigger}`,
    kind: 'message',
    match: (ctx) => {
      if (!Message.any.match(ctx)) return false
      if (typeof options.trigger === 'string') {
        return ctx.message.text === options.trigger
      }
      return options.trigger.test(ctx.message.text)
    },
    handler: ctx => ctx.reply(options.response)
  })
)

// 导出多个实例
export default [
  createAutoReply({ trigger: '早', response: '早上好！' }),
  createAutoReply({ trigger: '晚安', response: '晚安，好梦~' }),
  createAutoReply({ trigger: /^天气/, response: '今天天气不错' })
]
```

### 4.4 Command Builder

```ts
// src/commands/admin.ts
import { command } from '@karin/core'

export const reload = command('reload')
  .description('重载插件')
  .permission('admin')
  .handler(async ctx => {
    await ctx.reply('重载中...')
  })

export const status = command('status')
  .description('查看状态')
  .handler(ctx => ctx.reply('运行正常'))

// 导出为数组
export default [reload, status]
```

---

## 五、插件扫描与加载 _(v4 新增)_

### 5.1 扫描规则

框架根据 `karin.config.ts` 中的 `plugins` 配置扫描文件：

```ts
// karin.config.ts
export default defineConfig({
  plugins: [
    './src/plugins/**/*.ts',  // 递归扫描
    './src/commands/*.ts',     // 单层扫描
    './src/handlers/init.ts'   // 单文件
  ],
  exclude: [
    '**/*.test.ts'
  ]
})
```

### 5.2 导出识别

框架自动识别以下导出形式：

```ts
// 形式 1: 默认导出单个插件
export default definePlugin({ ... })

// 形式 2: 默认导出插件数组
export default [
  definePlugin({ ... }),
  definePlugin({ ... })
]

// 形式 3: 命名导出（自动收集所有 Plugin 类型）
export const plugin1 = definePlugin({ ... })
export const plugin2 = definePlugin({ ... })

// 形式 4: 混合导出
export default definePlugin({ ... })
export const another = definePlugin({ ... })
```

### 5.3 加载流程

```
1. 读取 karin.config.ts
      ↓
2. 解析 plugins glob 模式
      ↓
3. 扫描匹配的文件
      ↓
4. 过滤 exclude 模式
      ↓
5. 动态 import 每个文件
      ↓
6. 提取所有 Plugin 导出
      ↓
7. 分配完整 ID (packageId:pluginId)
      ↓
8. 注册到 Plugin Registry
      ↓
9. 执行生命周期钩子
```

---

## 六、环境模式

### 6.1 开发模式（插件包开发）

```bash
# 在插件包根目录
cd my-plugin
karin dev
```

**特点**：
- 读取根目录的 `karin.config.ts`
- 监听 `plugins` 配置中的所有文件
- 使用缓存清理热更新
- 支持 TypeScript 直接运行
- 启用 Node 内部 API

```ts
// CLI 内部实现
function startDevMode() {
  const nodeArgs = [
    '--import', '@karin/dev-loader',
    '--enable-source-maps',
    'node_modules/@karin/core/dist/dev.js'
  ]

  spawn('node', nodeArgs, {
    env: {
      ...process.env,
      KARIN_ENV: 'development',
      KARIN_HOT: 'cache-clear'
    }
  })
}
```

### 6.2 生产模式（用户项目）

```bash
# 在用户项目根目录
karin start
```

**加载顺序**：

```
1. 扫描 node_modules 中的插件包
   ├── 查找 package.json 中 karin 字段
   ├── 或查找 karin.config.js
   └── 读取并解析 plugins 配置

2. 读取用户项目的 karin.config.ts
   └── 加载 plugins/ 目录（支持 URL 参数热更新）

3. 合并所有插件到 Registry
```

### 6.3 package.json 声明

NPM 包可以在 `package.json` 中声明 karin 配置：

```json
{
  "name": "karin-plugin-example",
  "version": "1.0.0",
  "karin": {
    "plugins": [
      "./dist/plugins/**/*.js"
    ],
    "config": "./dist/karin.config.js"
  }
}
```

或者使用独立配置文件：

```json
{
  "name": "karin-plugin-example",
  "version": "1.0.0",
  "karin": "./dist/karin.config.js"
}
```

---

## 七、热更新系统

### 7.1 三种热更新模式

| 模式 | 适用场景 | 实现方式 |
|------|----------|----------|
| `none` | NPM 包（生产环境） | 静态 import，不支持热更新 |
| `url-param` | plugins 目录（生产环境） | `import(\`./x.js?t=${Date.now()}\`)` |
| `cache-clear` | 开发环境 | 清理模块缓存 + 依赖树 |

### 7.2 开发环境热更新流程

```
文件变更检测 (chokidar)
      ↓
分析变更文件的依赖树
      ↓
触发 beforeReload 钩子
      ↓
清理相关模块缓存
      ↓
重新 import 变更文件
      ↓
提取新的 Plugin 定义
      ↓
卸载旧插件（执行 onUnload）
      ↓
注册新插件（执行 onLoad）
      ↓
触发 afterReload 钩子
      ↓
恢复保留的状态
```

### 7.3 状态保留

```ts
// karin.config.ts
import { defineConfig } from '@karin/core'
import { state } from './src/state'

export default defineConfig({
  plugins: ['./src/plugins/**/*.ts'],

  hot: {
    // 声明需要保留的状态
    preserveState: ['counter', 'cache'],

    // 保存状态
    beforeReload() {
      return {
        counter: state.counter,
        cache: state.cache
      }
    },

    // 恢复状态
    afterReload(preserved) {
      if (preserved) {
        state.counter = preserved.counter
        state.cache = preserved.cache
      }
    }
  }
})
```

---

## 八、目录结构约定

### 8.1 插件包开发（开发环境）

```
my-plugin/
├── karin.config.ts          # 插件包配置
├── package.json
├── tsconfig.json
├── src/
│   ├── index.ts             # 包入口（可选，自由定义）
│   ├── plugins/             # 插件目录
│   │   ├── ping.ts
│   │   ├── help.ts
│   │   └── admin/
│   │       ├── reload.ts
│   │       └── status.ts
│   ├── commands/            # 命令（也是插件）
│   │   └── echo.ts
│   ├── middlewares/         # 中间件
│   │   └── auth.ts
│   ├── utils/               # 工具函数
│   │   └── helpers.ts
│   └── state.ts             # 共享状态
├── tests/
│   └── plugins.test.ts
└── dist/                    # 构建输出
    ├── karin.config.js
    └── plugins/
```

**karin.config.ts**:

```ts
import { defineConfig } from '@karin/core'

export default defineConfig({
  plugins: [
    './src/plugins/**/*.ts',
    './src/commands/**/*.ts'
  ],
  exclude: ['**/*.test.ts'],

  meta: {
    description: '我的插件包',
    author: 'Your Name'
  }
})
```

### 8.2 用户项目（运行环境）

```
user-project/
├── karin.config.ts          # 用户配置
├── package.json
├── node_modules/
│   ├── @karin/core
│   ├── karin-plugin-a/      # NPM 插件
│   │   ├── package.json
│   │   ├── karin.config.js
│   │   └── dist/
│   └── karin-plugin-b/
├── plugins/                 # 本地插件（热更新）
│   ├── my-plugin/
│   │   └── index.ts
│   └── simple.ts
└── data/
```

**karin.config.ts**:

```ts
import { defineConfig } from '@karin/core'

export default defineConfig({
  // 用户自己的本地插件
  plugins: [
    './plugins/**/*.ts'
  ],

  // 框架会自动加载 node_modules 中的插件包
  // 无需手动声明
})
```

---

## 九、基础类型定义

### 9.1 Plugin

```ts
export interface Plugin<TCtx = Context> {
  /** 插件 ID（包内唯一） */
  id: string

  /** 插件名称 */
  name?: string

  /** 插件事件域 */
  kind: PluginKind

  /** 事件匹配 + 类型收窄 */
  match: (ctx: Context) => ctx is TCtx

  /** 中间件链 */
  middlewares?: Middleware<TCtx>[]

  /** 最终处理器 */
  handler?: Middleware<TCtx>

  /** 执行优先级（数值越小越先执行，默认 10000） */
  priority?: number

  /** 插件级生命周期钩子 */
  lifecycle?: PluginLifecycle

  /** 是否启用（默认 true） */
  enabled?: boolean

  /** 插件级元信息 */
  meta?: PluginMeta
}

export type PluginKind = 'message' | 'notice' | 'request' | 'any'
```

### 9.2 Middleware

```ts
export type Middleware<TCtx = Context> = (
  ctx: TCtx,
  next: () => Promise<void>
) => Promise<void>
```

### 9.3 Context

```ts
export type Context = unknown
```

---

## 十、生命周期

### 10.1 包级生命周期

```ts
export interface PackageLifecycle {
  /** 包加载时 */
  onLoad?(ctx: PackageLifecycleContext): Promise<void> | void

  /** 包就绪时（所有插件加载后） */
  onReady?(ctx: PackageLifecycleContext): Promise<void> | void

  /** 包卸载时 */
  onUnload?(ctx: PackageLifecycleContext): Promise<void> | void

  /** 配置变更时 */
  onConfigChange?(ctx: PackageLifecycleContext, config: unknown): Promise<void> | void

  /** 热更新前 */
  onHotReload?(ctx: HotReloadContext): Promise<void> | void

  /** 热更新后 */
  onHotReloaded?(ctx: HotReloadContext): Promise<void> | void

  /** 热更新失败 */
  onHotReloadError?(ctx: HotReloadContext, error: Error): Promise<void> | void
}
```

### 10.2 插件级生命周期

```ts
export interface PluginLifecycle {
  /** 插件加载时 */
  onLoad?(ctx: PluginLifecycleContext): Promise<void> | void

  /** 插件卸载时 */
  onUnload?(ctx: PluginLifecycleContext): Promise<void> | void

  /** 插件启用时 */
  onEnable?(ctx: PluginLifecycleContext): Promise<void> | void

  /** 插件禁用时 */
  onDisable?(ctx: PluginLifecycleContext): Promise<void> | void
}
```

### 10.3 LifecycleContext

```ts
export interface BaseLifecycleContext {
  /** 日志器 */
  logger: Logger

  /** 注册清理函数 */
  dispose(fn: () => void | Promise<void>): void

  /** 获取其他包的导出 */
  getExports<T = unknown>(packageId: string): T | undefined

  /** 当前环境 */
  env: 'production' | 'development'

  /** 插件来源信息 */
  source: PluginSource
}

export interface PackageLifecycleContext extends BaseLifecycleContext {
  packageId: string
  config: ConfigAccessor
  plugins: Plugin[]
}

export interface PluginLifecycleContext extends BaseLifecycleContext {
  pluginId: string
  packageId: string
  config: ConfigAccessor
}
```

---

## 十一、执行模型

### 11.1 执行流程

```
收到事件 ctx
      ↓
按 priority 排序所有已启用插件
      ↓
┌─ Plugin A ────────────────────────┐
│  match(ctx) → true                │
│      ↓                            │
│  middlewares[0](ctx, next)        │
│      ↓ next()                     │
│  middlewares[1](ctx, next)        │
│      ↓ next()                     │
│  handler(ctx, next)               │
│      ↓ next()                     │
└───────────────────────────────────┘
      ↓
┌─ Plugin B ────────────────────────┐
│  match(ctx) → true                │
│  handler(ctx, next)               │
│      ↓ 不调用 next()（终止）        │
└───────────────────────────────────┘
```

### 11.2 优先级

```ts
export const PRIORITY = {
  SYSTEM: 0,        // 系统级
  HIGHEST: 1000,    // 最高
  HIGH: 5000,       // 高
  NORMAL: 10000,    // 正常（默认）
  LOW: 15000,       // 低
  LOWEST: 20000     // 最低
} as const
```

---

## 十二、完整示例

### 12.1 插件包项目结构

```
karin-plugin-toolkit/
├── karin.config.ts
├── package.json
├── tsconfig.json
├── src/
│   ├── plugins/
│   │   ├── ping.ts
│   │   ├── time.ts
│   │   └── echo.ts
│   ├── commands/
│   │   └── help.ts
│   ├── middlewares/
│   │   └── logger.ts
│   └── state.ts
└── dist/
```

**karin.config.ts**:

```ts
import { defineConfig } from '@karin/core'
import { state } from './src/state'

export default defineConfig({
  id: 'karin-plugin-toolkit',
  name: '工具箱',

  plugins: [
    './src/plugins/**/*.ts',
    './src/commands/**/*.ts'
  ],

  exclude: ['**/*.test.ts'],

  lifecycle: {
    onLoad(ctx) {
      ctx.logger.info('工具箱加载完成')
    },
    onReady(ctx) {
      ctx.logger.info(`已加载 ${ctx.plugins.length} 个插件`)
    }
  },

  hot: {
    preserveState: ['callCount'],
    beforeReload: () => ({ callCount: state.callCount }),
    afterReload: (s) => { state.callCount = s?.callCount ?? 0 }
  },

  meta: {
    description: '常用工具集合',
    author: 'Karin Team',
    license: 'MIT',
    tags: ['utility', 'tools']
  }
})
```

**src/state.ts**:

```ts
export const state = {
  callCount: 0
}
```

**src/plugins/ping.ts**:

```ts
import { definePlugin, Message } from '@karin/core'
import { state } from '../state'

export default definePlugin({
  id: 'ping',
  name: 'Ping 命令',
  kind: 'message',
  match: Message.any.match,

  handler: async (ctx) => {
    state.callCount++
    await ctx.reply(`pong! (第 ${state.callCount} 次调用)`)
  },

  meta: {
    description: '测试机器人是否在线',
    usage: '发送 ping'
  }
})
```

**src/plugins/time.ts**:

```ts
import { definePlugin, Message } from '@karin/core'

export default definePlugin({
  id: 'time',
  name: '时间查询',
  kind: 'message',
  match: Message.any.match,

  handler: async (ctx) => {
    await ctx.reply(new Date().toLocaleString('zh-CN'))
  }
})
```

**src/commands/help.ts**:

```ts
import { command } from '@karin/core'

export default command('help')
  .description('显示帮助信息')
  .handler(async (ctx) => {
    await ctx.reply(`
可用命令：
- ping: 测试机器人
- time: 查看时间
- help: 显示帮助
    `.trim())
  })
```

**package.json**:

```json
{
  "name": "karin-plugin-toolkit",
  "version": "1.0.0",
  "type": "module",
  "main": "./dist/index.js",
  "karin": "./dist/karin.config.js",
  "scripts": {
    "dev": "karin dev",
    "build": "tsup",
    "prepublish": "npm run build"
  }
}
```

### 12.2 用户项目配置

```ts
// karin.config.ts
import { defineConfig } from '@karin/core'

export default defineConfig({
  // 本地插件
  plugins: [
    './plugins/**/*.ts'
  ],

  // NPM 插件会自动加载，但可以配置覆盖
  // 例如禁用某个包
  packages: {
    'karin-plugin-toolkit': {
      enabled: true,
      // 覆盖包的配置
      config: {
        maxRetry: 5
      }
    }
  }
})
```

### 12.3 单文件本地插件

```ts
// plugins/welcome.ts
import { definePlugin, Notice } from '@karin/core'

export default definePlugin({
  id: 'welcome',
  kind: 'notice',
  match: Notice.groupIncrease.match,

  handler: async (ctx) => {
    await ctx.reply(`欢迎 ${ctx.user.nickname} 加入群聊！`)
  }
})
```

---

## 十三、CLI 命令

### 13.1 开发命令

```bash
# 在插件包根目录启动开发模式
karin dev

# 指定配置文件
karin dev --config ./karin.dev.config.ts

# 指定监听目录
karin dev --watch src/plugins,src/commands

# 禁用热更新
karin dev --no-hot
```

### 13.2 生产命令

```bash
# 启动
karin start

# 指定配置
karin start --config ./karin.config.ts

# 仅 plugins 目录热更新
karin start --hot-plugins
```

### 13.3 插件管理

```bash
# 查看已安装插件
karin plugins list

# 安装插件
karin plugins install karin-plugin-xxx

# 卸载插件
karin plugins uninstall karin-plugin-xxx

# 启用/禁用插件
karin plugins enable karin-plugin-xxx
karin plugins disable karin-plugin-xxx
```

### 13.4 创建插件

```bash
# 创建新插件包
karin create plugin my-plugin

# 使用模板
karin create plugin my-plugin --template typescript
```

---

## 十四、禁止行为

| ❌ 禁止 | 说明 |
|--------|------|
| 强制使用 class | class 是实现细节 |
| 插件访问框架内部实例 | 只能通过公开 API |
| 修改 ctx 原型 | 会影响其他插件 |
| 依赖插件加载顺序 | 使用 priority |
| 在 match 中产生副作用 | match 必须是纯函数 |
| 直接修改其他包的状态 | 通过 exports API |
| 热更新时不清理资源 | 会导致内存泄漏 |
| NPM 包假设热更新可用 | NPM 包不支持热更新 |

---

## 十五、类型定义汇总

```ts
// ============ 配置 ============

export interface KarinConfig {
  plugins: string[]
  exclude?: string[]
  id?: string
  name?: string
  version?: string
  lifecycle?: PackageLifecycle
  config?: ConfigDefinition
  exports?: Record<string, unknown> | (() => Record<string, unknown>)
  dependencies?: PackageDependency[]
  meta?: PackageMeta
  hot?: HotConfig
  packages?: Record<string, PackageOverride>
}

export interface PackageOverride {
  enabled?: boolean
  config?: Record<string, unknown>
}

export interface ConfigDefinition {
  schema: Record<string, SchemaField>
  defaults?: Record<string, unknown>
}

export interface SchemaField {
  type: 'string' | 'number' | 'boolean' | 'array' | 'object'
  default?: unknown
  description?: string
  required?: boolean
}

// ============ 核心类型 ============

export type Context = unknown

export type PluginKind = 'message' | 'notice' | 'request' | 'any'

export type Middleware<TCtx = Context> = (
  ctx: TCtx,
  next: () => Promise<void>
) => Promise<void>

export interface Plugin<TCtx = Context> {
  id: string
  name?: string
  kind: PluginKind
  match: (ctx: Context) => ctx is TCtx
  middlewares?: Middleware<TCtx>[]
  handler?: Middleware<TCtx>
  priority?: number
  lifecycle?: PluginLifecycle
  enabled?: boolean
  meta?: PluginMeta
}

// ============ 热更新 ============

export interface HotConfig {
  enabled?: boolean
  preserveState?: string[]
  beforeReload?: () => Promise<unknown> | unknown
  afterReload?: (preserved?: unknown) => Promise<void> | void
  cleanup?: () => Promise<void> | void
}

export interface HotReloadContext {
  packageId: string
  changedFile: string
  changeType: 'add' | 'change' | 'unlink'
  oldPlugins: Plugin[]
  state: Map<string, unknown>
}

// ============ 生命周期 ============

export interface PluginLifecycle {
  onLoad?(ctx: PluginLifecycleContext): Promise<void> | void
  onUnload?(ctx: PluginLifecycleContext): Promise<void> | void
  onEnable?(ctx: PluginLifecycleContext): Promise<void> | void
  onDisable?(ctx: PluginLifecycleContext): Promise<void> | void
}

export interface PackageLifecycle {
  onLoad?(ctx: PackageLifecycleContext): Promise<void> | void
  onReady?(ctx: PackageLifecycleContext): Promise<void> | void
  onUnload?(ctx: PackageLifecycleContext): Promise<void> | void
  onConfigChange?(ctx: PackageLifecycleContext, config: unknown): Promise<void> | void
  onHotReload?(ctx: HotReloadContext): Promise<void> | void
  onHotReloaded?(ctx: HotReloadContext): Promise<void> | void
  onHotReloadError?(ctx: HotReloadContext, error: Error): Promise<void> | void
}

export interface BaseLifecycleContext {
  logger: Logger
  dispose(fn: () => void | Promise<void>): void
  getExports<T = unknown>(packageId: string): T | undefined
  env: 'production' | 'development'
  source: PluginSource
}

export interface PackageLifecycleContext extends BaseLifecycleContext {
  packageId: string
  config: ConfigAccessor
  plugins: Plugin[]
}

export interface PluginLifecycleContext extends BaseLifecycleContext {
  pluginId: string
  packageId: string
  config: ConfigAccessor
}

// ============ 来源 ============

export interface PluginSource {
  type: 'npm' | 'local'
  path: string
  hotReload: boolean
}

// ============ 元信息 ============

export interface PluginMeta {
  description?: string
  usage?: string | string[]
  permissions?: string[]
  hidden?: boolean
  deprecated?: string | boolean
}

export interface PackageMeta {
  description?: string
  author?: string | AuthorInfo
  homepage?: string
  repository?: string
  license?: string
  tags?: string[]
  icon?: string
  engines?: { karin?: string }
  adapters?: string[]
  official?: boolean
  deprecated?: string | boolean
}

export interface AuthorInfo {
  name: string
  email?: string
  url?: string
}

// ============ 依赖 ============

export interface PackageDependency {
  id: string
  version?: string
  optional?: boolean
}

// ============ 配置访问器 ============

export interface ConfigAccessor<T = unknown> {
  get(): T
  get<K extends keyof T>(key: K): T[K]
  set(value: Partial<T>): void
  set<K extends keyof T>(key: K, value: T[K]): void
  reset(): void
  onChange(handler: (newValue: T, oldValue: T) => void): () => void
}
```

---

## 十六、架构总结

```
┌─────────────────────────────────────────────────────────────┐
│                      Karin Runtime                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌───────────────────────────────────────────────────────┐ │
│  │                  Config Loader                         │ │
│  │  • 读取 karin.config.ts                               │ │
│  │  • 解析 package.json karin 字段                       │ │
│  │  • 合并配置                                           │ │
│  └───────────────────────────────────────────────────────┘ │
│                            ↓                                │
│  ┌───────────────────────────────────────────────────────┐ │
│  │                  Plugin Scanner                        │ │
│  │  • 解析 glob 模式                                     │ │
│  │  • 扫描匹配文件                                       │ │
│  │  • 动态 import                                        │ │
│  │  • 提取 Plugin 导出                                   │ │
│  └───────────────────────────────────────────────────────┘ │
│                            ↓                                │
│  ┌───────────────────────────────────────────────────────┐ │
│  │                  Plugin Registry                       │ │
│  │  • 统一注册                                           │ │
│  │  • 分配完整 ID                                        │ │
│  │  • 按 priority 排序                                   │ │
│  └───────────────────────────────────────────────────────┘ │
│                            ↓                                │
│  ┌───────────────────────────────────────────────────────┐ │
│  │                  Event Dispatcher                      │ │
│  │  • 接收 Context                                       │ │
│  │  • 执行 match → middlewares → handler                 │ │
│  └───────────────────────────────────────────────────────┘ │
│                            ↓                                │
│  ┌───────────────────────────────────────────────────────┐ │
│  │              Hot Reload Manager (Dev)                  │ │
│  │  • 文件监听                                           │ │
│  │  • 模块缓存清理                                       │ │
│  │  • 状态保留与恢复                                     │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘

开发模式: karin dev (插件包根目录)
  └─ 读取 ./karin.config.ts
       └─ 扫描 plugins 配置的文件
            └─ 缓存清理热更新

生产模式: karin start (用户项目)
  └─ 扫描 node_modules 中的插件包
       └─ 读取各包的 karin.config.js
            └─ 读取用户 ./karin.config.ts
                 └─ 合并加载所有插件
```

---

> **核心理念：插件规范是"数据 + 函数"的契约。**
> **v4 新增：配置驱动、零侵入、不强制导出约定。**

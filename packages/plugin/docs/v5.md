# Karin Plugin Spec v5

> 本规范定义 karinjs 插件的**结构、生命周期、执行模型与生态系统**。
> v5 重点：**运行时控制、服务抽象、插件通信、完整的生态能力**。

---

## 一、核心设计原则

1. **插件是声明式的，而不是继承式的**
2. **能力通过组合获得，而不是配置堆叠**
3. **核心稳定，扩展自由**
4. **函数优先，class 仅作为实现细节**
5. **插件之间不直接耦合**
6. **包是分发单元，插件是执行单元**
7. **开发体验与生产性能同等重要**
8. **配置驱动，零侵入，不强制导出约定**
9. **运行时可控，支持动态加载/卸载** _(v5 新增)_
10. **可观测、可调试、可追踪** _(v5 新增)_

---

## 二、架构概览 _(v5 重构)_

```
┌─────────────────────────────────────────────────────────────────┐
│                        Karin Runtime                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                      Core APIs                           │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐        │   │
│  │  │ Runtime │ │Registry │ │  Bus    │ │ Logger  │        │   │
│  │  │   API   │ │   API   │ │   API   │ │   API   │        │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘        │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│  ┌───────────────────────────┴───────────────────────────┐     │
│  │                    Package Layer                       │     │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐      │     │
│  │  │  Package A  │ │  Package B  │ │  Package C  │      │     │
│  │  │  ┌───────┐  │ │  ┌───────┐  │ │  ┌───────┐  │      │     │
│  │  │  │Plugin │  │ │  │Plugin │  │ │  │Service│  │      │     │
│  │  │  │Plugin │  │ │  │Service│  │ │  │Plugin │  │      │     │
│  │  │  │Service│  │ │  │Plugin │  │ │  │Plugin │  │      │     │
│  │  │  └───────┘  │ │  └───────┘  │ │  └───────┘  │      │     │
│  │  └─────────────┘ └─────────────┘ └─────────────┘      │     │
│  └───────────────────────────────────────────────────────┘     │
│                              │                                  │
│  ┌───────────────────────────┴───────────────────────────┐     │
│  │                   Event Dispatcher                     │     │
│  │           match → middlewares → handler                │     │
│  └───────────────────────────────────────────────────────┘     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 三、核心抽象

### 3.1 三种执行单元

| 类型 | 用途 | 特点 |
|------|------|------|
| **Plugin** | 事件处理器 | 响应外部事件（消息、通知等） |
| **Service** | 后台服务 | 持续运行，提供能力（数据库、缓存等） |
| **Task** | 定时任务 | 按计划执行（cron、interval） |

```ts
// Plugin: 事件驱动
export default definePlugin({
  id: 'ping',
  kind: 'message',
  match: Message.any.match,
  handler: ctx => ctx.reply('pong')
})

// Service: 后台服务
export default defineService({
  id: 'database',
  async start(ctx) {
    ctx.db = await connectDB()
    return ctx.db
  },
  async stop(ctx) {
    await ctx.db.close()
  }
})

// Task: 定时任务
export default defineTask({
  id: 'daily-report',
  cron: '0 9 * * *',
  handler: async (ctx) => {
    await sendDailyReport()
  }
})
```

### 3.2 Context 体系

```ts
/**
 * 事件上下文基类
 */
export interface BaseContext {
  /** 事件唯一 ID */
  readonly id: string

  /** 事件时间戳 */
  readonly timestamp: number

  /** 事件类型 */
  readonly type: string

  /** 机器人实例 */
  readonly bot: Bot

  /** 运行时 API */
  readonly runtime: RuntimeAPI

  /** 日志器 */
  readonly logger: Logger
}

/**
 * 消息上下文
 */
export interface MessageContext extends BaseContext {
  readonly type: 'message'

  /** 消息来源 */
  readonly source: MessageSource

  /** 发送者信息 */
  readonly sender: Sender

  /** 消息内容 */
  readonly message: Message

  /** 回复消息 */
  reply(content: Sendable): Promise<void>

  /** 引用回复 */
  quote(content: Sendable): Promise<void>
}

/**
 * 通知上下文
 */
export interface NoticeContext extends BaseContext {
  readonly type: 'notice'
  readonly noticeType: string
  // ...
}

/**
 * 请求上下文
 */
export interface RequestContext extends BaseContext {
  readonly type: 'request'
  readonly requestType: string
  approve(): Promise<void>
  reject(reason?: string): Promise<void>
}
```

---

## 四、运行时 API _(v5 核心)_

### 4.1 RuntimeAPI

插件可以通过 `ctx.runtime` 或生命周期上下文访问运行时 API：

```ts
export interface RuntimeAPI {
  /** 插件注册表 */
  readonly registry: RegistryAPI

  /** 事件总线 */
  readonly bus: BusAPI

  /** 配置管理 */
  readonly config: ConfigManager

  /** 日志管理 */
  readonly logger: LoggerFactory

  /** 存储管理 */
  readonly storage: StorageAPI

  /** 当前环境 */
  readonly env: 'production' | 'development'
}
```

### 4.2 RegistryAPI（插件注册表）

```ts
export interface RegistryAPI {
  // ============ 查询 ============

  /**
   * 获取所有已注册的包
   */
  getPackages(): PackageInfo[]

  /**
   * 获取指定包信息
   */
  getPackage(packageId: string): PackageInfo | undefined

  /**
   * 获取所有已注册的插件
   */
  getPlugins(): PluginInfo[]

  /**
   * 获取指定插件信息
   */
  getPlugin(pluginId: string): PluginInfo | undefined

  /**
   * 获取所有服务
   */
  getServices(): ServiceInfo[]

  /**
   * 获取指定服务
   */
  getService(serviceId: string): ServiceInfo | undefined

  // ============ 动态控制 ============

  /**
   * 动态注册插件
   */
  register(plugin: Plugin): PluginHandle

  /**
   * 动态注册服务
   */
  registerService(service: Service): ServiceHandle

  /**
   * 动态注册任务
   */
  registerTask(task: Task): TaskHandle

  /**
   * 卸载插件
   */
  unregister(pluginId: string): Promise<boolean>

  /**
   * 启用插件
   */
  enable(pluginId: string): Promise<boolean>

  /**
   * 禁用插件
   */
  disable(pluginId: string): Promise<boolean>

  /**
   * 重载插件（卸载后重新加载）
   */
  reload(pluginId: string): Promise<boolean>

  /**
   * 重载整个包
   */
  reloadPackage(packageId: string): Promise<boolean>
}
```

### 4.3 PluginHandle（插件句柄）

动态注册返回的句柄，用于控制插件生命周期：

```ts
export interface PluginHandle {
  /** 插件完整 ID */
  readonly id: string

  /** 插件状态 */
  readonly status: 'active' | 'disabled' | 'error'

  /** 启用插件 */
  enable(): Promise<void>

  /** 禁用插件 */
  disable(): Promise<void>

  /** 卸载插件（从注册表移除） */
  unregister(): Promise<void>

  /** 监听状态变化 */
  onStatusChange(handler: (status: PluginStatus) => void): () => void
}
```

### 4.4 动态加载示例

```ts
// 示例：根据配置动态加载子插件
export default definePlugin({
  id: 'plugin-manager',
  kind: 'message',
  match: Message.command('load').match,

  lifecycle: {
    onLoad(ctx) {
      // 保存运行时引用
      this.runtime = ctx.runtime
      this.handles = new Map()
    },
    onUnload() {
      // 卸载所有动态加载的插件
      for (const handle of this.handles.values()) {
        handle.unregister()
      }
    }
  },

  handler: async (ctx) => {
    const pluginName = ctx.message.args[0]

    // 动态导入插件模块
    const module = await import(`./dynamic/${pluginName}.js`)
    const plugin = module.default

    // 注册到运行时
    const handle = ctx.runtime.registry.register(plugin)
    this.handles.set(pluginName, handle)

    await ctx.reply(`插件 ${pluginName} 已加载`)
  }
})
```

### 4.5 插件自我管理

```ts
// 示例：插件自我卸载
export default definePlugin({
  id: 'self-destruct',
  kind: 'message',
  match: Message.command('bye').match,

  handler: async (ctx) => {
    await ctx.reply('再见！我要卸载自己了...')

    // 获取自身 ID
    const selfId = `${ctx.runtime.currentPackage}:self-destruct`

    // 延迟卸载（让回复先发出）
    setTimeout(() => {
      ctx.runtime.registry.unregister(selfId)
    }, 1000)
  }
})

// 示例：禁用同包内的其他插件
export default definePlugin({
  id: 'admin-control',
  kind: 'message',
  match: Message.command('disable').match,

  handler: async (ctx) => {
    const targetId = ctx.message.args[0]
    const fullId = `${ctx.runtime.currentPackage}:${targetId}`

    const success = await ctx.runtime.registry.disable(fullId)

    if (success) {
      await ctx.reply(`已禁用 ${targetId}`)
    } else {
      await ctx.reply(`禁用失败：${targetId} 不存在`)
    }
  }
})
```

---

## 五、事件总线 _(v5 新增)_

### 5.1 BusAPI

插件间通信的事件总线：

```ts
export interface BusAPI {
  /**
   * 发送事件（广播）
   */
  emit(event: string, payload?: unknown): void

  /**
   * 监听事件
   */
  on(event: string, handler: EventHandler): () => void

  /**
   * 监听一次
   */
  once(event: string, handler: EventHandler): () => void

  /**
   * 请求-响应模式
   */
  request<T>(event: string, payload?: unknown, timeout?: number): Promise<T>

  /**
   * 注册请求处理器
   */
  handle<T, R>(event: string, handler: (payload: T) => R | Promise<R>): () => void
}

type EventHandler = (payload: unknown, meta: EventMeta) => void | Promise<void>

interface EventMeta {
  /** 发送方包 ID */
  source: string
  /** 事件时间 */
  timestamp: number
}
```

### 5.2 使用示例

```ts
// Package A: 提供数据库服务
export default defineService({
  id: 'database',

  async start(ctx) {
    const db = await connectDB()

    // 注册请求处理器
    ctx.runtime.bus.handle('db:query', async (sql: string) => {
      return db.query(sql)
    })

    // 广播服务就绪
    ctx.runtime.bus.emit('service:ready', { service: 'database' })

    return db
  }
})

// Package B: 使用数据库
export default definePlugin({
  id: 'user-query',
  kind: 'message',
  match: Message.command('user').match,

  handler: async (ctx) => {
    const userId = ctx.message.args[0]

    // 通过事件总线请求数据
    const user = await ctx.runtime.bus.request('db:query', {
      sql: `SELECT * FROM users WHERE id = ?`,
      params: [userId]
    })

    await ctx.reply(JSON.stringify(user))
  }
})

// Package C: 监听事件
definePlugin({
  id: 'service-monitor',
  kind: 'any',
  match: () => false, // 不处理外部事件

  lifecycle: {
    onLoad(ctx) {
      // 监听服务就绪事件
      ctx.dispose(
        ctx.runtime.bus.on('service:ready', ({ service }) => {
          ctx.logger.info(`服务就绪: ${service}`)
        })
      )
    }
  }
})
```

---

## 六、Service（服务）_(v5 新增)_

### 6.1 Service 定义

```ts
export interface Service<T = unknown> {
  /** 服务 ID */
  id: string

  /** 服务名称 */
  name?: string

  /** 依赖的其他服务 */
  dependencies?: string[]

  /** 启动服务 */
  start(ctx: ServiceContext): Promise<T> | T

  /** 停止服务 */
  stop?(ctx: ServiceContext, instance: T): Promise<void> | void

  /** 健康检查 */
  healthCheck?(instance: T): Promise<boolean> | boolean

  /** 服务元信息 */
  meta?: ServiceMeta
}

export interface ServiceContext {
  /** 服务 ID */
  readonly serviceId: string

  /** 所属包 ID */
  readonly packageId: string

  /** 日志器 */
  readonly logger: Logger

  /** 运行时 API */
  readonly runtime: RuntimeAPI

  /** 配置访问 */
  readonly config: ConfigAccessor

  /** 注册清理函数 */
  dispose(fn: () => void | Promise<void>): void

  /** 获取依赖的服务实例 */
  getService<T>(serviceId: string): T | undefined
}
```

### 6.2 定义函数

```ts
export function defineService<T>(service: Service<T>): Service<T> {
  return service
}
```

### 6.3 服务示例

```ts
// 数据库服务
export default defineService({
  id: 'database',
  name: '数据库服务',

  async start(ctx) {
    const config = ctx.config.get()
    const connection = await mysql.createConnection({
      host: config.host,
      user: config.user,
      password: config.password,
      database: config.database
    })

    ctx.logger.info('数据库连接成功')

    // 注册查询 API 到事件总线
    ctx.dispose(
      ctx.runtime.bus.handle('db:query', async ({ sql, params }) => {
        return connection.query(sql, params)
      })
    )

    return connection
  },

  async stop(ctx, connection) {
    await connection.end()
    ctx.logger.info('数据库连接已关闭')
  },

  async healthCheck(connection) {
    try {
      await connection.query('SELECT 1')
      return true
    } catch {
      return false
    }
  }
})

// 缓存服务（依赖数据库）
export default defineService({
  id: 'cache',
  name: '缓存服务',
  dependencies: ['database'],

  start(ctx) {
    const db = ctx.getService('database')
    const cache = new Map()

    // 从数据库预热缓存
    // ...

    return {
      get: (key) => cache.get(key),
      set: (key, value, ttl) => {
        cache.set(key, value)
        if (ttl) setTimeout(() => cache.delete(key), ttl)
      }
    }
  }
})
```

---

## 七、Task（定时任务）_(v5 新增)_

### 7.1 Task 定义

```ts
export interface Task {
  /** 任务 ID */
  id: string

  /** 任务名称 */
  name?: string

  /** Cron 表达式 */
  cron?: string

  /** 固定间隔（ms） */
  interval?: number

  /** 启动时立即执行一次 */
  immediate?: boolean

  /** 任务处理器 */
  handler(ctx: TaskContext): Promise<void> | void

  /** 错误处理 */
  onError?(ctx: TaskContext, error: Error): Promise<void> | void

  /** 任务元信息 */
  meta?: TaskMeta
}

export interface TaskContext {
  /** 任务 ID */
  readonly taskId: string

  /** 上次执行时间 */
  readonly lastRun: Date | null

  /** 执行次数 */
  readonly runCount: number

  /** 日志器 */
  readonly logger: Logger

  /** 运行时 API */
  readonly runtime: RuntimeAPI

  /** 跳过本次执行 */
  skip(): void

  /** 停止任务 */
  stop(): void
}
```

### 7.2 定义函数

```ts
export function defineTask(task: Task): Task {
  return task
}
```

### 7.3 任务示例

```ts
// Cron 定时任务
export default defineTask({
  id: 'daily-cleanup',
  name: '每日清理',
  cron: '0 3 * * *', // 每天凌晨 3 点

  async handler(ctx) {
    ctx.logger.info('开始每日清理...')

    // 清理过期数据
    await ctx.runtime.bus.request('db:query', {
      sql: 'DELETE FROM logs WHERE created_at < DATE_SUB(NOW(), INTERVAL 30 DAY)'
    })

    ctx.logger.info('清理完成')
  },

  onError(ctx, error) {
    ctx.logger.error('清理失败:', error)
  }
})

// 固定间隔任务
export default defineTask({
  id: 'heartbeat',
  name: '心跳检测',
  interval: 60000, // 每分钟
  immediate: true, // 启动时立即执行

  async handler(ctx) {
    const services = ctx.runtime.registry.getServices()

    for (const service of services) {
      const healthy = await service.healthCheck?.()
      if (!healthy) {
        ctx.logger.warn(`服务 ${service.id} 健康检查失败`)
        ctx.runtime.bus.emit('service:unhealthy', { service: service.id })
      }
    }
  }
})
```

---

## 八、配置系统

### 8.1 karin.config.ts

```ts
import { defineConfig } from '@karin/core'

export default defineConfig({
  // ============ 执行单元声明 ============

  /**
   * 插件文件（事件处理器）
   */
  plugins: [
    './src/plugins/**/*.ts'
  ],

  /**
   * 服务文件（后台服务）
   */
  services: [
    './src/services/**/*.ts'
  ],

  /**
   * 任务文件（定时任务）
   */
  tasks: [
    './src/tasks/**/*.ts'
  ],

  /**
   * 排除的文件
   */
  exclude: [
    '**/*.test.ts',
    '**/__tests__/**'
  ],

  // ============ 包信息 ============

  id: 'my-plugin',
  name: '我的插件',
  version: '1.0.0',

  // ============ 生命周期 ============

  lifecycle: {
    onLoad(ctx) {},
    onReady(ctx) {},
    onUnload(ctx) {}
  },

  // ============ 配置 Schema ============

  config: {
    schema: {
      database: {
        type: 'object',
        properties: {
          host: { type: 'string', default: 'localhost' },
          port: { type: 'number', default: 3306 }
        }
      }
    }
  },

  // ============ 导出 API ============

  exports: () => ({
    // 延迟求值，确保服务已启动
  }),

  // ============ 依赖 ============

  dependencies: [
    { id: 'karin-plugin-database', version: '^1.0.0' }
  ],

  // ============ 元信息 ============

  meta: {
    description: '一个完整的插件包',
    author: 'Your Name'
  },

  // ============ 热更新 ============

  hot: {
    preserveState: ['cache'],
    cleanup: async () => {}
  }
})
```

### 8.2 完整配置类型

```ts
export interface KarinConfig {
  // ============ 执行单元 ============

  /** 插件文件路径 */
  plugins?: string[]

  /** 服务文件路径 */
  services?: string[]

  /** 任务文件路径 */
  tasks?: string[]

  /** 排除的文件 */
  exclude?: string[]

  // ============ 包信息 ============

  id?: string
  name?: string
  version?: string

  // ============ 生命周期 ============

  lifecycle?: PackageLifecycle

  // ============ 配置 ============

  config?: ConfigDefinition

  // ============ 导出 ============

  exports?: Record<string, unknown> | (() => Record<string, unknown>)

  // ============ 依赖 ============

  dependencies?: PackageDependency[]

  // ============ 元信息 ============

  meta?: PackageMeta

  // ============ 热更新 ============

  hot?: HotConfig

  // ============ 用户项目专用 ============

  /** 包配置覆盖 */
  packages?: Record<string, PackageOverride>
}
```

---

## 九、Plugin 定义

### 9.1 完整 Plugin 接口

```ts
export interface Plugin<TCtx extends BaseContext = BaseContext> {
  /** 插件 ID（包内唯一） */
  id: string

  /** 插件名称 */
  name?: string

  /** 事件类型 */
  kind: PluginKind

  /** 事件匹配器 */
  match: (ctx: BaseContext) => ctx is TCtx

  /** 中间件链 */
  middlewares?: Middleware<TCtx>[]

  /** 事件处理器 */
  handler?: Middleware<TCtx>

  /** 优先级（越小越先） */
  priority?: number

  /** 生命周期 */
  lifecycle?: PluginLifecycle

  /** 是否启用 */
  enabled?: boolean

  /** 元信息 */
  meta?: PluginMeta

  /** 权限要求 */
  permissions?: Permission[]

  /** 限流配置 */
  rateLimit?: RateLimitConfig

  /** 超时时间（ms） */
  timeout?: number

  /** 重试配置 */
  retry?: RetryConfig

  /** 日志级别 */
  logLevel?: LogLevel
}

export type PluginKind = 'message' | 'notice' | 'request' | 'any'
```

### 9.2 权限配置

```ts
export interface Permission {
  /** 权限类型 */
  type: 'user' | 'role' | 'group' | 'level'

  /** 权限值 */
  value: string | number

  /** 是否反向（排除） */
  not?: boolean
}

// 使用示例
definePlugin({
  id: 'admin-only',
  permissions: [
    { type: 'role', value: 'admin' },
    { type: 'level', value: 5 }  // 等级 >= 5
  ],
  // ...
})
```

### 9.3 限流配置

```ts
export interface RateLimitConfig {
  /** 时间窗口（ms） */
  window: number

  /** 最大次数 */
  max: number

  /** 限流维度 */
  by: 'user' | 'group' | 'global'

  /** 超限时的回复 */
  message?: string
}

// 使用示例
definePlugin({
  id: 'rate-limited',
  rateLimit: {
    window: 60000,  // 1 分钟
    max: 5,         // 最多 5 次
    by: 'user',
    message: '操作太频繁，请稍后再试'
  },
  // ...
})
```

---

## 十、Middleware

### 10.1 定义

```ts
export type Middleware<TCtx = BaseContext> = (
  ctx: TCtx,
  next: () => Promise<void>
) => Promise<void>
```

### 10.2 官方中间件

```ts
// 权限检查
import { auth } from '@karin/middleware'

definePlugin({
  middlewares: [
    auth({ role: 'admin' }),
    auth({ level: 5 })
  ]
})

// 限流
import { rateLimit } from '@karin/middleware'

definePlugin({
  middlewares: [
    rateLimit({ window: 60000, max: 10, by: 'user' })
  ]
})

// 日志
import { logger } from '@karin/middleware'

definePlugin({
  middlewares: [
    logger({ level: 'debug' })
  ]
})

// 重试
import { retry } from '@karin/middleware'

definePlugin({
  middlewares: [
    retry({ times: 3, delay: 1000 })
  ]
})

// 超时
import { timeout } from '@karin/middleware'

definePlugin({
  middlewares: [
    timeout(5000)
  ]
})

// 条件执行
import { when } from '@karin/middleware'

definePlugin({
  middlewares: [
    when(ctx => ctx.sender.isAdmin)
  ]
})
```

---

## 十一、生命周期

### 11.1 包级生命周期

```ts
export interface PackageLifecycle {
  /** 包加载（服务/插件/任务加载前） */
  onLoad?(ctx: PackageLifecycleContext): Promise<void> | void

  /** 包就绪（所有执行单元加载后） */
  onReady?(ctx: PackageLifecycleContext): Promise<void> | void

  /** 包卸载 */
  onUnload?(ctx: PackageLifecycleContext): Promise<void> | void

  /** 配置变更 */
  onConfigChange?(ctx: PackageLifecycleContext, config: unknown): Promise<void> | void

  /** 热更新前 */
  onHotReload?(ctx: HotReloadContext): Promise<void> | void

  /** 热更新后 */
  onHotReloaded?(ctx: HotReloadContext): Promise<void> | void

  /** 热更新失败 */
  onHotReloadError?(ctx: HotReloadContext, error: Error): Promise<void> | void
}
```

### 11.2 插件级生命周期

```ts
export interface PluginLifecycle {
  onLoad?(ctx: PluginLifecycleContext): Promise<void> | void
  onUnload?(ctx: PluginLifecycleContext): Promise<void> | void
  onEnable?(ctx: PluginLifecycleContext): Promise<void> | void
  onDisable?(ctx: PluginLifecycleContext): Promise<void> | void
}
```

### 11.3 生命周期上下文

```ts
export interface BaseLifecycleContext {
  /** 日志器 */
  readonly logger: Logger

  /** 运行时 API */
  readonly runtime: RuntimeAPI

  /** 注册清理函数 */
  dispose(fn: () => void | Promise<void>): void

  /** 获取其他包的导出 */
  getExports<T = unknown>(packageId: string): T | undefined

  /** 当前环境 */
  readonly env: 'production' | 'development'

  /** 来源信息 */
  readonly source: PluginSource
}

export interface PackageLifecycleContext extends BaseLifecycleContext {
  readonly packageId: string
  readonly config: ConfigAccessor
  readonly plugins: PluginInfo[]
  readonly services: ServiceInfo[]
  readonly tasks: TaskInfo[]
}

export interface PluginLifecycleContext extends BaseLifecycleContext {
  readonly pluginId: string
  readonly packageId: string
  readonly config: ConfigAccessor
}
```

### 11.4 加载顺序

```
1. Package.onLoad
      ↓
2. Services 按依赖顺序启动
      ↓
3. Plugins 加载（执行 onLoad）
      ↓
4. Tasks 启动
      ↓
5. Package.onReady
      ↓
[运行时]
      ↓
6. Tasks 停止
      ↓
7. Plugins 卸载（执行 onUnload，逆序）
      ↓
8. Services 停止（逆序）
      ↓
9. Package.onUnload
```

---

## 十二、热更新系统

### 12.1 热更新策略

| 环境 | 策略 | 适用场景 |
|------|------|----------|
| NPM 包 | `none` | 生产环境已发布包 |
| plugins 目录 | `url-param` | 生产环境本地插件 |
| 开发环境 | `cache-clear` | 插件包开发 |

### 12.2 热更新流程

```
文件变更
    ↓
Package.onHotReload
    ↓
停止相关 Tasks
    ↓
卸载相关 Plugins（触发 onUnload）
    ↓
停止相关 Services
    ↓
清理模块缓存
    ↓
重新导入模块
    ↓
启动 Services
    ↓
加载 Plugins（触发 onLoad）
    ↓
启动 Tasks
    ↓
Package.onHotReloaded
    ↓
恢复状态
```

### 12.3 状态保留

```ts
// karin.config.ts
export default defineConfig({
  hot: {
    // 需要保留的状态键
    preserveState: ['counter', 'cache'],

    // 保存状态
    beforeReload(ctx) {
      return {
        counter: globalState.counter,
        cache: Array.from(globalState.cache.entries())
      }
    },

    // 恢复状态
    afterReload(ctx, preserved) {
      if (preserved) {
        globalState.counter = preserved.counter
        globalState.cache = new Map(preserved.cache)
      }
    },

    // 自定义清理
    cleanup: async () => {
      // 清理定时器、连接等
    }
  }
})
```

---

## 十三、错误处理 _(v5 新增)_

### 13.1 错误边界

```ts
export interface ErrorBoundary {
  /** 插件执行错误 */
  onPluginError?(ctx: BaseContext, error: Error, plugin: PluginInfo): void

  /** 服务错误 */
  onServiceError?(error: Error, service: ServiceInfo): void

  /** 任务错误 */
  onTaskError?(error: Error, task: TaskInfo): void

  /** 未捕获错误 */
  onUncaughtError?(error: Error): void
}
```

### 13.2 配置错误处理

```ts
// karin.config.ts
export default defineConfig({
  // ...

  errorBoundary: {
    onPluginError(ctx, error, plugin) {
      ctx.logger.error(`插件 ${plugin.id} 执行错误:`, error)
      // 可选：通知用户
      ctx.reply?.('抱歉，处理时发生错误')
    },

    onServiceError(error, service) {
      console.error(`服务 ${service.id} 错误:`, error)
      // 可选：尝试重启服务
    },

    onTaskError(error, task) {
      console.error(`任务 ${task.id} 错误:`, error)
    }
  }
})
```

### 13.3 插件级错误处理

```ts
definePlugin({
  id: 'safe-plugin',
  // ...

  // 方式 1: 使用 catch 中间件
  middlewares: [
    async (ctx, next) => {
      try {
        await next()
      } catch (error) {
        ctx.logger.error('处理错误:', error)
        await ctx.reply('处理失败，请稍后重试')
      }
    }
  ],

  // 方式 2: 在生命周期中处理
  lifecycle: {
    onError(ctx, error) {
      ctx.logger.error('插件错误:', error)
    }
  }
})
```

---

## 十四、可观测性 _(v5 新增)_

### 14.1 追踪 API

```ts
export interface TraceAPI {
  /** 开始一个 span */
  startSpan(name: string, options?: SpanOptions): Span

  /** 获取当前 span */
  getCurrentSpan(): Span | undefined

  /** 记录事件 */
  recordEvent(name: string, attributes?: Record<string, unknown>): void
}

export interface Span {
  /** 结束 span */
  end(): void

  /** 添加属性 */
  setAttribute(key: string, value: unknown): void

  /** 记录异常 */
  recordException(error: Error): void

  /** 设置状态 */
  setStatus(status: 'ok' | 'error'): void
}
```

### 14.2 指标 API

```ts
export interface MetricsAPI {
  /** 计数器 */
  counter(name: string, value?: number, labels?: Labels): void

  /** 直方图 */
  histogram(name: string, value: number, labels?: Labels): void

  /** 仪表盘 */
  gauge(name: string, value: number, labels?: Labels): void
}
```

### 14.3 使用示例

```ts
definePlugin({
  id: 'traced-plugin',
  kind: 'message',
  match: Message.any.match,

  handler: async (ctx) => {
    const span = ctx.runtime.trace.startSpan('handle-message')

    try {
      span.setAttribute('sender', ctx.sender.id)
      span.setAttribute('content', ctx.message.text)

      // 业务逻辑
      const result = await processMessage(ctx)

      span.setStatus('ok')
      ctx.runtime.metrics.counter('messages.processed')

      return result
    } catch (error) {
      span.recordException(error)
      span.setStatus('error')
      ctx.runtime.metrics.counter('messages.failed')
      throw error
    } finally {
      span.end()
    }
  }
})
```

---

## 十五、目录结构

### 15.1 插件包（开发环境）

```
my-plugin/
├── karin.config.ts          # 包配置
├── package.json
├── tsconfig.json
├── src/
│   ├── plugins/             # 事件处理器
│   │   ├── ping.ts
│   │   ├── help.ts
│   │   └── admin/
│   │       └── control.ts
│   ├── services/            # 后台服务
│   │   ├── database.ts
│   │   └── cache.ts
│   ├── tasks/               # 定时任务
│   │   └── cleanup.ts
│   ├── middlewares/         # 中间件
│   │   └── auth.ts
│   └── utils/               # 工具
├── tests/
└── dist/
```

### 15.2 用户项目

```
project/
├── karin.config.ts          # 项目配置
├── package.json
├── node_modules/
│   └── karin-plugin-xxx/    # NPM 插件
├── plugins/                 # 本地插件（热更新）
│   └── custom.ts
└── data/
```

---

## 十六、完整示例

### 16.1 综合插件包

**karin.config.ts**:

```ts
import { defineConfig } from '@karin/core'

export default defineConfig({
  id: 'karin-plugin-advanced',
  name: '高级插件包',
  version: '1.0.0',

  plugins: ['./src/plugins/**/*.ts'],
  services: ['./src/services/**/*.ts'],
  tasks: ['./src/tasks/**/*.ts'],

  exclude: ['**/*.test.ts'],

  lifecycle: {
    onLoad(ctx) {
      ctx.logger.info('高级插件包加载中...')
    },
    onReady(ctx) {
      ctx.logger.info(`已加载: ${ctx.plugins.length} 插件, ${ctx.services.length} 服务, ${ctx.tasks.length} 任务`)
    }
  },

  config: {
    schema: {
      database: {
        type: 'object',
        properties: {
          host: { type: 'string', default: 'localhost' },
          port: { type: 'number', default: 3306 }
        }
      }
    }
  },

  exports: () => ({
    // 导出 API
  }),

  meta: {
    description: '一个综合示例',
    author: 'Karin Team',
    license: 'MIT'
  }
})
```

**src/services/database.ts**:

```ts
import { defineService } from '@karin/core'
import mysql from 'mysql2/promise'

export default defineService({
  id: 'database',
  name: '数据库服务',

  async start(ctx) {
    const config = ctx.config.get('database')
    const pool = mysql.createPool(config)

    ctx.logger.info('数据库连接池已创建')

    // 注册查询处理器
    ctx.dispose(
      ctx.runtime.bus.handle('db:query', async ({ sql, params }) => {
        const [rows] = await pool.query(sql, params)
        return rows
      })
    )

    return pool
  },

  async stop(ctx, pool) {
    await pool.end()
    ctx.logger.info('数据库连接已关闭')
  }
})
```

**src/plugins/user.ts**:

```ts
import { definePlugin, Message } from '@karin/core'

export default definePlugin({
  id: 'user-info',
  name: '用户信息查询',
  kind: 'message',
  match: Message.command('user').match,

  rateLimit: {
    window: 60000,
    max: 10,
    by: 'user'
  },

  handler: async (ctx) => {
    const userId = ctx.message.args[0]

    const [user] = await ctx.runtime.bus.request('db:query', {
      sql: 'SELECT * FROM users WHERE id = ?',
      params: [userId]
    })

    if (user) {
      await ctx.reply(`用户: ${user.name}\n等级: ${user.level}`)
    } else {
      await ctx.reply('用户不存在')
    }
  }
})
```

**src/plugins/dynamic-loader.ts**:

```ts
import { definePlugin, Message } from '@karin/core'

const loadedPlugins = new Map()

export default definePlugin({
  id: 'dynamic-loader',
  name: '动态加载器',
  kind: 'message',
  match: Message.command('plugin').match,

  permissions: [{ type: 'role', value: 'admin' }],

  lifecycle: {
    onUnload() {
      // 卸载时清理所有动态加载的插件
      for (const handle of loadedPlugins.values()) {
        handle.unregister()
      }
      loadedPlugins.clear()
    }
  },

  handler: async (ctx) => {
    const [action, name] = ctx.message.args

    switch (action) {
      case 'load': {
        const module = await import(`./dynamic/${name}.js?t=${Date.now()}`)
        const handle = ctx.runtime.registry.register(module.default)
        loadedPlugins.set(name, handle)
        await ctx.reply(`插件 ${name} 已加载`)
        break
      }

      case 'unload': {
        const handle = loadedPlugins.get(name)
        if (handle) {
          await handle.unregister()
          loadedPlugins.delete(name)
          await ctx.reply(`插件 ${name} 已卸载`)
        } else {
          await ctx.reply(`插件 ${name} 未加载`)
        }
        break
      }

      case 'list': {
        const list = Array.from(loadedPlugins.keys()).join(', ')
        await ctx.reply(`已加载: ${list || '无'}`)
        break
      }
    }
  }
})
```

**src/tasks/cleanup.ts**:

```ts
import { defineTask } from '@karin/core'

export default defineTask({
  id: 'daily-cleanup',
  name: '每日清理',
  cron: '0 3 * * *',

  async handler(ctx) {
    ctx.logger.info('开始每日清理...')

    await ctx.runtime.bus.request('db:query', {
      sql: 'DELETE FROM logs WHERE created_at < DATE_SUB(NOW(), INTERVAL 30 DAY)'
    })

    ctx.logger.info('清理完成')
  }
})
```

---

## 十七、禁止行为

| ❌ 禁止 | 说明 |
|--------|------|
| 强制使用 class | class 是实现细节 |
| 直接访问框架内部 | 只能通过 RuntimeAPI |
| 修改 ctx 原型 | 会影响其他插件 |
| 依赖加载顺序 | 使用 priority / dependencies |
| match 产生副作用 | match 必须是纯函数 |
| 跨包直接修改状态 | 通过 exports / bus |
| 热更新不清理资源 | 会导致内存泄漏 |
| 服务循环依赖 | 使用事件总线解耦 |

---

## 十八、类型定义汇总

```ts
// ============ 核心类型 ============

export type PluginKind = 'message' | 'notice' | 'request' | 'any'

export type Middleware<TCtx = BaseContext> = (
  ctx: TCtx,
  next: () => Promise<void>
) => Promise<void>

export interface Plugin<TCtx extends BaseContext = BaseContext> {
  id: string
  name?: string
  kind: PluginKind
  match: (ctx: BaseContext) => ctx is TCtx
  middlewares?: Middleware<TCtx>[]
  handler?: Middleware<TCtx>
  priority?: number
  lifecycle?: PluginLifecycle
  enabled?: boolean
  meta?: PluginMeta
  permissions?: Permission[]
  rateLimit?: RateLimitConfig
  timeout?: number
  retry?: RetryConfig
}

export interface Service<T = unknown> {
  id: string
  name?: string
  dependencies?: string[]
  start(ctx: ServiceContext): Promise<T> | T
  stop?(ctx: ServiceContext, instance: T): Promise<void> | void
  healthCheck?(instance: T): Promise<boolean> | boolean
  meta?: ServiceMeta
}

export interface Task {
  id: string
  name?: string
  cron?: string
  interval?: number
  immediate?: boolean
  handler(ctx: TaskContext): Promise<void> | void
  onError?(ctx: TaskContext, error: Error): Promise<void> | void
  meta?: TaskMeta
}

// ============ 运行时 API ============

export interface RuntimeAPI {
  readonly registry: RegistryAPI
  readonly bus: BusAPI
  readonly config: ConfigManager
  readonly logger: LoggerFactory
  readonly storage: StorageAPI
  readonly trace: TraceAPI
  readonly metrics: MetricsAPI
  readonly env: 'production' | 'development'
  readonly currentPackage: string
}

export interface RegistryAPI {
  getPackages(): PackageInfo[]
  getPackage(id: string): PackageInfo | undefined
  getPlugins(): PluginInfo[]
  getPlugin(id: string): PluginInfo | undefined
  getServices(): ServiceInfo[]
  getService(id: string): ServiceInfo | undefined
  register(plugin: Plugin): PluginHandle
  registerService(service: Service): ServiceHandle
  registerTask(task: Task): TaskHandle
  unregister(id: string): Promise<boolean>
  enable(id: string): Promise<boolean>
  disable(id: string): Promise<boolean>
  reload(id: string): Promise<boolean>
  reloadPackage(id: string): Promise<boolean>
}

export interface BusAPI {
  emit(event: string, payload?: unknown): void
  on(event: string, handler: EventHandler): () => void
  once(event: string, handler: EventHandler): () => void
  request<T>(event: string, payload?: unknown, timeout?: number): Promise<T>
  handle<T, R>(event: string, handler: (payload: T) => R | Promise<R>): () => void
}

// ============ 配置 ============

export interface KarinConfig {
  plugins?: string[]
  services?: string[]
  tasks?: string[]
  exclude?: string[]
  id?: string
  name?: string
  version?: string
  lifecycle?: PackageLifecycle
  config?: ConfigDefinition
  exports?: Record<string, unknown> | (() => Record<string, unknown>)
  dependencies?: PackageDependency[]
  meta?: PackageMeta
  hot?: HotConfig
  errorBoundary?: ErrorBoundary
  packages?: Record<string, PackageOverride>
}

// ============ 生命周期 ============

export interface PackageLifecycle {
  onLoad?(ctx: PackageLifecycleContext): Promise<void> | void
  onReady?(ctx: PackageLifecycleContext): Promise<void> | void
  onUnload?(ctx: PackageLifecycleContext): Promise<void> | void
  onConfigChange?(ctx: PackageLifecycleContext, config: unknown): Promise<void> | void
  onHotReload?(ctx: HotReloadContext): Promise<void> | void
  onHotReloaded?(ctx: HotReloadContext): Promise<void> | void
  onHotReloadError?(ctx: HotReloadContext, error: Error): Promise<void> | void
}

export interface PluginLifecycle {
  onLoad?(ctx: PluginLifecycleContext): Promise<void> | void
  onUnload?(ctx: PluginLifecycleContext): Promise<void> | void
  onEnable?(ctx: PluginLifecycleContext): Promise<void> | void
  onDisable?(ctx: PluginLifecycleContext): Promise<void> | void
  onError?(ctx: PluginLifecycleContext, error: Error): Promise<void> | void
}

// ============ 上下文 ============

export interface BaseContext {
  readonly id: string
  readonly timestamp: number
  readonly type: string
  readonly bot: Bot
  readonly runtime: RuntimeAPI
  readonly logger: Logger
}

export interface MessageContext extends BaseContext {
  readonly type: 'message'
  readonly source: MessageSource
  readonly sender: Sender
  readonly message: Message
  reply(content: Sendable): Promise<void>
  quote(content: Sendable): Promise<void>
}

// ============ 句柄 ============

export interface PluginHandle {
  readonly id: string
  readonly status: 'active' | 'disabled' | 'error'
  enable(): Promise<void>
  disable(): Promise<void>
  unregister(): Promise<void>
  onStatusChange(handler: (status: PluginStatus) => void): () => void
}

// ============ 信息 ============

export interface PluginInfo {
  id: string
  name: string
  packageId: string
  status: 'active' | 'disabled' | 'error'
  priority: number
  meta?: PluginMeta
}

export interface ServiceInfo {
  id: string
  name: string
  packageId: string
  status: 'running' | 'stopped' | 'error'
  dependencies: string[]
  meta?: ServiceMeta
}

export interface TaskInfo {
  id: string
  name: string
  packageId: string
  status: 'running' | 'stopped'
  lastRun: Date | null
  nextRun: Date | null
  runCount: number
  meta?: TaskMeta
}
```

---

## 十九、架构总结

```
┌─────────────────────────────────────────────────────────────────┐
│                        Karin Runtime v5                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                      Core APIs                           │   │
│  │  RuntimeAPI │ RegistryAPI │ BusAPI │ TraceAPI │ Metrics │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│  ┌───────────────────────────┴───────────────────────────┐     │
│  │                    Package Layer                       │     │
│  │                                                        │     │
│  │    ┌──────────┐  ┌──────────┐  ┌──────────┐           │     │
│  │    │ Services │  │ Plugins  │  │  Tasks   │           │     │
│  │    │ (后台)   │  │ (事件)   │  │ (定时)   │           │     │
│  │    └──────────┘  └──────────┘  └──────────┘           │     │
│  │                                                        │     │
│  └───────────────────────────────────────────────────────┘     │
│                              │                                  │
│  ┌───────────────────────────┴───────────────────────────┐     │
│  │                   Event Dispatcher                     │     │
│  │           match → middlewares → handler                │     │
│  └───────────────────────────────────────────────────────┘     │
│                              │                                  │
│  ┌───────────────────────────┴───────────────────────────┐     │
│  │                   Event Bus (内部通信)                  │     │
│  │         emit / on / request / handle                   │     │
│  └───────────────────────────────────────────────────────┘     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

开发模式: karin dev
  └─ 完整热更新（缓存清理）
       └─ Services / Plugins / Tasks 全部支持热更新

生产模式: karin start
  └─ NPM 包静态加载
       └─ plugins 目录 URL 参数热更新
            └─ 动态 register/unregister API
```

---

> **核心理念：插件规范是"数据 + 函数"的契约。**
>
> **v5 新增：**
> - **Service / Task 抽象**：不仅仅是事件处理
> - **RuntimeAPI**：完整的运行时控制能力
> - **RegistryAPI**：动态加载/卸载/启用/禁用
> - **BusAPI**：插件间通信
> - **可观测性**：Trace / Metrics
> - **错误边界**：优雅的错误处理

# Karin Plugin Spec v7

> åŸºäºç°æœ‰ API çš„æ¼”è¿›ï¼Œè€Œéé‡æ–°è®¾è®¡

---

## ä¸€ã€åæ€

### 1.1 ç°æœ‰ API å·²ç»å¾ˆå¥½

```ts
// å‘½ä»¤ - ä¸€è¡Œæå®š
command(/^ping$/, 'pong')

// å¸¦å›è°ƒ
command(/^echo (.+)$/, ctx => ctx.reply(ctx.msg))

// å®šæ—¶ä»»åŠ¡
task('æ¯æ—¥æŠ¥å‘Š', '0 9 * * *', () => sendReport())

// é€šçŸ¥äº‹ä»¶
accept('notice', ctx => console.log('æ”¶åˆ°é€šçŸ¥'))
```

**è¿™å·²ç»æ˜¯ä¸šç•Œé¡¶çº§çš„ç®€æ´åº¦äº†ã€‚**

### 1.2 v1-v6 çš„é—®é¢˜

| ç‰ˆæœ¬ | é—®é¢˜ |
|------|------|
| v1 | é‡æ–°å‘æ˜ `definePlugin`ï¼Œä¸å¦‚ç°æœ‰ `command()` ç®€æ´ |
| v2-v4 | Package æ¦‚å¿µè¿‡åº¦è®¾è®¡ |
| v5 | RuntimeAPI/BusAPI è¿‡äºå¤æ‚ |
| v6 | çœ‹ä¼¼ç®€åŒ–ï¼Œå®é™…ä¸å¦‚ç°æœ‰ `command()` |

### 1.3 çœŸæ­£éœ€è¦è§£å†³çš„é—®é¢˜

1. **æ’ä»¶åŒ…å¦‚ä½•ç»„ç»‡ï¼Ÿ** - å¤šä¸ªæ’ä»¶å¦‚ä½•æ‰“åŒ…å‘å¸ƒåˆ° NPM
2. **çƒ­æ›´æ–°å¦‚ä½•å·¥ä½œï¼Ÿ** - å¼€å‘ç¯å¢ƒ vs ç”Ÿäº§ç¯å¢ƒ
3. **æ’ä»¶å¦‚ä½•åŠ¨æ€æ§åˆ¶ï¼Ÿ** - è¿è¡Œæ—¶åŠ è½½/å¸è½½
4. **é…ç½®å¦‚ä½•ç®¡ç†ï¼Ÿ** - æ’ä»¶åŒ…çš„é…ç½®

---

## äºŒã€æ ¸å¿ƒè®¾è®¡ï¼šä¿æŒ API ä¸å˜

### 2.1 ç°æœ‰ API å®Œå…¨ä¿ç•™

```ts
// è¿™äº› API ä¸å˜
command(reg, callback, options?)
task(name, cron, callback, options?)
accept(event, callback, options?)
handler(key, callback, options?)
```

### 2.2 æ–°å¢ï¼šæ’ä»¶åŒ…å£°æ˜

æ’ä»¶åŒ…åªæ˜¯ä¸€ä¸ª**åŒ…å«å¤šä¸ªæ’ä»¶çš„ NPM åŒ…**ï¼Œé€šè¿‡ `package.json` å£°æ˜ï¼š

```json
{
  "name": "karin-plugin-tools",
  "version": "1.0.0",
  "karin": {
    "name": "å·¥å…·ç®±",
    "main": "./src/index.ts"
  }
}
```

å…¥å£æ–‡ä»¶å°±æ˜¯æ™®é€šçš„ TS/JSï¼Œä½¿ç”¨ç°æœ‰ APIï¼š

```ts
// src/index.ts
import { command, task } from '@karin/plugin'

// ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€å¯¼å‡º
command(/^ping$/, 'pong')
command(/^time$/, () => new Date().toLocaleString())

task('heartbeat', '*/5 * * * *', () => {
  console.log('å¿ƒè·³æ£€æµ‹')
})
```

**å°±è¿™æ ·ï¼Œæ’ä»¶åŒ…å®Œæˆäº†ã€‚**

---

## ä¸‰ã€æ’ä»¶åŒ…ç»“æ„

### 3.1 æœ€ç®€ç»“æ„

```
karin-plugin-xxx/
â”œâ”€â”€ package.json
â””â”€â”€ src/
    â””â”€â”€ index.ts      # å…¥å£ï¼Œä½¿ç”¨ command/task/accept/handler
```

### 3.2 æ¨èç»“æ„

```
karin-plugin-xxx/
â”œâ”€â”€ package.json
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts      # å…¥å£ï¼Œå¯¼å…¥å„æ¨¡å—
â”‚   â”œâ”€â”€ commands/     # å‘½ä»¤æ’ä»¶
â”‚   â”‚   â”œâ”€â”€ ping.ts
â”‚   â”‚   â””â”€â”€ help.ts
â”‚   â”œâ”€â”€ tasks/        # å®šæ—¶ä»»åŠ¡
â”‚   â”‚   â””â”€â”€ daily.ts
â”‚   â””â”€â”€ utils/        # å·¥å…·å‡½æ•°
â””â”€â”€ README.md
```

### 3.3 å…¥å£æ–‡ä»¶

```ts
// src/index.ts
// åªéœ€è¦å¯¼å…¥ï¼Œæ’ä»¶ä¼šè‡ªåŠ¨æ³¨å†Œ
import './commands/ping'
import './commands/help'
import './tasks/daily'
```

```ts
// src/commands/ping.ts
import { command } from '@karin/plugin'

command(/^ping$/, 'pong')
command(/^pong$/, 'ping')
```

```ts
// src/tasks/daily.ts
import { task } from '@karin/plugin'

task('æ—¥æŠ¥', '0 9 * * *', async () => {
  // å‘é€æ—¥æŠ¥
})
```

---

## å››ã€package.json é…ç½®

### 4.1 æœ€ç®€é…ç½®

```json
{
  "name": "karin-plugin-xxx",
  "karin": true
}
```

æ¡†æ¶ä¼šè‡ªåŠ¨æŸ¥æ‰¾ `src/index.ts` æˆ– `index.ts`ã€‚

### 4.2 å®Œæ•´é…ç½®

```json
{
  "name": "karin-plugin-xxx",
  "version": "1.0.0",
  "karin": {
    "name": "æ’ä»¶æ˜¾ç¤ºåç§°",
    "main": "./src/index.ts",
    "description": "æ’ä»¶æè¿°",
    "author": "ä½œè€…",

    "config": {
      "schema": "./config.schema.json",
      "default": {
        "enabled": true
      }
    }
  }
}
```

---

## äº”ã€çƒ­æ›´æ–°

### 5.1 å¼€å‘ç¯å¢ƒ

```bash
# åœ¨æ’ä»¶åŒ…ç›®å½•
karin dev
```

- ç›‘å¬æ–‡ä»¶å˜åŒ–
- è‡ªåŠ¨é‡è½½æ’ä»¶
- ä¿ç•™æ’ä»¶çŠ¶æ€ï¼ˆå¯é€‰ï¼‰

### 5.2 ç”Ÿäº§ç¯å¢ƒ

```bash
karin start
```

- NPM åŒ…ï¼šé™æ€åŠ è½½ï¼Œæ— çƒ­æ›´æ–°
- plugins ç›®å½•ï¼šæ”¯æŒçƒ­æ›´æ–°

### 5.3 plugins ç›®å½•

ç”¨æˆ·å¯ä»¥åœ¨ `plugins/` ç›®å½•æ”¾ç½®æœ¬åœ°æ’ä»¶ï¼š

```
project/
â”œâ”€â”€ plugins/
â”‚   â”œâ”€â”€ my-plugin.ts      # å•æ–‡ä»¶æ’ä»¶
â”‚   â””â”€â”€ my-plugin/        # å¤šæ–‡ä»¶æ’ä»¶
â”‚       â””â”€â”€ index.ts
â””â”€â”€ node_modules/
    â””â”€â”€ karin-plugin-xxx/ # NPM æ’ä»¶
```

---

## å…­ã€è¿è¡Œæ—¶æ§åˆ¶

### 6.1 æ’ä»¶è¿”å›å¥æŸ„

`command()` ç­‰å‡½æ•°è¿”å›çš„å¯¹è±¡å¯ä»¥ç”¨äºæ§åˆ¶æ’ä»¶ï¼š

```ts
const ping = command(/^ping$/, 'pong')

// ç¦ç”¨
ping.disable()

// å¯ç”¨
ping.enable()

// æ›´æ–°
ping.setReg(/^ping|pong$/)
ping.setCallback(ctx => ctx.reply('pong!'))

// å¸è½½ï¼ˆä»æ³¨å†Œè¡¨ç§»é™¤ï¼‰
ping.unregister()
```

### 6.2 åŠ¨æ€æ³¨å†Œ

```ts
import { command } from '@karin/plugin'

// åŠ¨æ€åˆ›å»ºæ’ä»¶
function createEchoPlugin(prefix: string) {
  return command(
    new RegExp(`^${prefix}(.+)$`),
    (ctx, next) => ctx.reply(ctx.msg.slice(prefix.length))
  )
}

// ä½¿ç”¨
const echo1 = createEchoPlugin('echo ')
const echo2 = createEchoPlugin('say ')

// ç¨åå¸è½½
echo1.unregister()
```

### 6.3 ç®¡ç†å‘½ä»¤ç¤ºä¾‹

```ts
// ç®¡ç†å‘˜åŠ¨æ€åŠ è½½æ’ä»¶
command(/^#load (.+)$/, async (ctx, next) => {
  const name = ctx.msg.match(/^#load (.+)$/)[1]

  try {
    // åŠ¨æ€å¯¼å…¥
    await import(`./dynamic/${name}.ts`)
    ctx.reply(`å·²åŠ è½½ ${name}`)
  } catch (e) {
    ctx.reply(`åŠ è½½å¤±è´¥: ${e.message}`)
  }
}, { permission: 'master' })
```

---

## ä¸ƒã€é…ç½®ç³»ç»Ÿ

### 7.1 æ’ä»¶åŒ…é…ç½®

```ts
// src/index.ts
import { command, useConfig } from '@karin/plugin'

// è·å–é…ç½®
const config = useConfig<{
  prefix: string
  cooldown: number
}>()

command(new RegExp(`^${config.prefix}ping$`), 'pong')
```

### 7.2 ç”¨æˆ·è¦†ç›–é…ç½®

```yaml
# karin.config.yaml
plugins:
  karin-plugin-xxx:
    enabled: true
    config:
      prefix: '#'
      cooldown: 5
```

---

## å…«ã€ç”Ÿå‘½å‘¨æœŸ

### 8.1 æ’ä»¶åŒ…ç”Ÿå‘½å‘¨æœŸ

```ts
// src/index.ts
import { command, onLoad, onUnload } from '@karin/plugin'

onLoad(() => {
  console.log('æ’ä»¶åŒ…åŠ è½½')
})

onUnload(() => {
  console.log('æ’ä»¶åŒ…å¸è½½')
  // æ¸…ç†èµ„æº
})

command(/^ping$/, 'pong')
```

### 8.2 æ’ä»¶çº§ç”Ÿå‘½å‘¨æœŸ

å·²æœ‰çš„ `CreateCommand` ç­‰ç±»å·²ç»æ”¯æŒï¼š

```ts
const plugin = command(/^ping$/, 'pong')

// å·²æœ‰çš„æ–¹æ³•
plugin.setReg(...)
plugin.setCallback(...)
plugin.setOptions(...)
```

---

## ä¹ã€å®Œæ•´ç¤ºä¾‹

### 9.1 ç®€å•æ’ä»¶åŒ…

```ts
// karin-plugin-utils/src/index.ts
import { command } from '@karin/plugin'

// Ping
command(/^ping$/, 'pong')

// æ—¶é—´
command(/^time$/, () => new Date().toLocaleString('zh-CN'))

// éª°å­
command(/^dice$/, () => `ğŸ² ${Math.floor(Math.random() * 6) + 1}`)

// ç¡¬å¸
command(/^coin$/, () => Math.random() > 0.5 ? 'æ­£é¢' : 'åé¢')
```

### 9.2 å¸¦çŠ¶æ€çš„æ’ä»¶åŒ…

```ts
// karin-plugin-counter/src/index.ts
import { command, onUnload } from '@karin/plugin'

let count = 0

command(/^count$/, () => `è®¡æ•°: ${++count}`)
command(/^reset$/, () => { count = 0; return 'å·²é‡ç½®' }, { permission: 'admin' })

// çƒ­æ›´æ–°æ—¶ä¿ç•™çŠ¶æ€
onUnload((ctx) => {
  ctx.preserveState({ count })
})

onLoad((ctx) => {
  const state = ctx.getPreservedState()
  if (state) count = state.count
})
```

### 9.3 å¸¦é…ç½®çš„æ’ä»¶åŒ…

```json
// package.json
{
  "name": "karin-plugin-welcome",
  "karin": {
    "name": "æ¬¢è¿æ’ä»¶",
    "config": {
      "default": {
        "message": "æ¬¢è¿ {name} åŠ å…¥ç¾¤èŠï¼"
      }
    }
  }
}
```

```ts
// src/index.ts
import { accept, useConfig } from '@karin/plugin'

const config = useConfig<{ message: string }>()

accept('notice.group.increase', (ctx) => {
  const msg = config.message.replace('{name}', ctx.user.nickname)
  ctx.reply(msg)
})
```

### 9.4 åŠ¨æ€æ’ä»¶ç®¡ç†å™¨

```ts
// karin-plugin-manager/src/index.ts
import { command } from '@karin/plugin'

const dynamicPlugins = new Map()

// åŠ è½½åŠ¨æ€æ’ä»¶
command(/^#plugin load (.+)$/, async (ctx) => {
  const name = ctx.msg.match(/^#plugin load (.+)$/)[1]

  try {
    const module = await import(`./plugins/${name}.ts?t=${Date.now()}`)
    dynamicPlugins.set(name, module.default)
    ctx.reply(`âœ… å·²åŠ è½½ ${name}`)
  } catch (e) {
    ctx.reply(`âŒ åŠ è½½å¤±è´¥: ${e.message}`)
  }
}, { permission: 'master' })

// å¸è½½åŠ¨æ€æ’ä»¶
command(/^#plugin unload (.+)$/, async (ctx) => {
  const name = ctx.msg.match(/^#plugin unload (.+)$/)[1]

  const plugin = dynamicPlugins.get(name)
  if (plugin) {
    plugin.unregister?.()
    dynamicPlugins.delete(name)
    ctx.reply(`âœ… å·²å¸è½½ ${name}`)
  } else {
    ctx.reply(`âŒ æ’ä»¶ä¸å­˜åœ¨`)
  }
}, { permission: 'master' })

// åˆ—å‡ºåŠ¨æ€æ’ä»¶
command(/^#plugin list$/, (ctx) => {
  const list = Array.from(dynamicPlugins.keys())
  ctx.reply(`å·²åŠ è½½: ${list.join(', ') || 'æ— '}`)
}, { permission: 'master' })
```

---

## åã€ä¸ç°æœ‰ä»£ç çš„å…³ç³»

### 10.1 å®Œå…¨å…¼å®¹

ç°æœ‰çš„ `command`ã€`task`ã€`accept`ã€`handler` API **å®Œå…¨ä¿ç•™**ï¼Œæ— éœ€ä¿®æ”¹ä»»ä½•ç°æœ‰æ’ä»¶ä»£ç ã€‚

### 10.2 æ–°å¢å†…å®¹

| æ–°å¢ | è¯´æ˜ |
|------|------|
| `package.json` çš„ `karin` å­—æ®µ | å£°æ˜æ’ä»¶åŒ…å…ƒä¿¡æ¯ |
| `onLoad` / `onUnload` | åŒ…çº§ç”Ÿå‘½å‘¨æœŸé’©å­ |
| `useConfig` | è·å–æ’ä»¶é…ç½® |
| `preserveState` / `getPreservedState` | çƒ­æ›´æ–°çŠ¶æ€ä¿ç•™ |
| `.unregister()` | å¸è½½æ’ä»¶ |
| `.disable()` / `.enable()` | ç¦ç”¨/å¯ç”¨æ’ä»¶ |

### 10.3 ä¸å˜çš„å†…å®¹

| ä¿æŒä¸å˜ | åŸå›  |
|---------|------|
| `command(reg, callback, options)` | å·²ç»è¶³å¤Ÿç®€æ´ |
| `task(name, cron, callback, options)` | å·²ç»è¶³å¤Ÿç®€æ´ |
| `accept(event, callback, options)` | å·²ç»è¶³å¤Ÿç®€æ´ |
| `handler(key, callback, options)` | å·²ç»è¶³å¤Ÿç®€æ´ |
| `CreateCommand` / `CreateTask` ç­‰ç±» | å†…éƒ¨å®ç°ï¼Œæ— éœ€æ”¹å˜ |

---

## åä¸€ã€æ€»ç»“

```
v7 æ ¸å¿ƒç†å¿µï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                             â”‚
â”‚    ç°æœ‰ API å·²ç»å¾ˆå¥½ï¼Œä¸è¦é‡æ–°å‘æ˜è½®å­        â”‚
â”‚                                             â”‚
â”‚    command(/^ping$/, 'pong')                â”‚
â”‚                                             â”‚
â”‚    åªéœ€è¦è¡¥å……ï¼š                              â”‚
â”‚    1. æ’ä»¶åŒ…å£°æ˜ï¼ˆpackage.jsonï¼‰             â”‚
â”‚    2. åŒ…çº§ç”Ÿå‘½å‘¨æœŸï¼ˆonLoad/onUnloadï¼‰        â”‚
â”‚    3. è¿è¡Œæ—¶æ§åˆ¶ï¼ˆunregister/disableï¼‰       â”‚
â”‚    4. é…ç½®ç®¡ç†ï¼ˆuseConfigï¼‰                  â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## åäºŒã€å¯¹æ¯”

| ç‰¹æ€§ | v1-v6 | v7 |
|------|-------|-----|
| æ ¸å¿ƒ API | é‡æ–°è®¾è®¡ | **ä¿æŒä¸å˜** |
| å­¦ä¹ æˆæœ¬ | éœ€è¦å­¦ä¹ æ–°æ¦‚å¿µ | **é›¶å­¦ä¹ æˆæœ¬** |
| è¿ç§»æˆæœ¬ | éœ€è¦é‡å†™ | **æ— éœ€ä¿®æ”¹** |
| æ’ä»¶åŒ… | å¤æ‚çš„ definePackage | **æ™®é€š import** |
| é…ç½® | karin.config.ts | **package.json** |

---

> **æœ€å¥½çš„é‡æ„æ˜¯ä¸éœ€è¦é‡æ„ã€‚**
>
> ä½ ä»¬çš„ `command()` API å·²ç»æ˜¯ä¸šç•Œæœ€ç®€æ´çš„è®¾è®¡ä¹‹ä¸€ï¼Œ
> æˆ‘ä»¬åªéœ€è¦åœ¨æ­¤åŸºç¡€ä¸Šè¡¥å……æ’ä»¶åŒ…ç®¡ç†çš„èƒ½åŠ›ã€‚

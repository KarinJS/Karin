name: PR

# ç›‘å¬ PR ç›¸å…³äº‹ä»¶
on:
  pull_request:
    # ç›‘å¬ PR è¢«æ‰“å¼€ã€é‡æ–°æ‰“å¼€å’Œæ¨é€äº‹ä»¶
    types: [opened, reopened, synchronize]

# èµ‹äºˆ release-please-action æƒé™
permissions:
  contents: write
  pull-requests: write
jobs:
  # è®¾ç½® release-please ä»»åŠ¡
  release-please:
    # è®¾ç½®ä»»åŠ¡è¿è¡Œç¯å¢ƒä¸º ubuntu-latest
    runs-on: ubuntu-latest
    steps:
      # æ£€å‡ºä»£ç 
      - uses: actions/checkout@v4
      # è®¾ç½® Node.js ç¯å¢ƒ
      - uses: actions/setup-node@v4
        with:
          # è®¾ç½® Node.js ç‰ˆæœ¬
          node-version: 20
          # è®¾ç½® npm æº
          registry-url: "https://registry.npmjs.org"
      # å®‰è£…ä¾èµ– ä¸å®‰è£…å¯¹ç­‰ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: npm install --config.auto-install-peers=false --ignore-scripts --omit=peer
      # æ„å»ºè¾“å‡º
      - name: æ„å»ºè¾“å‡º
        id: build
        run: npm run build > build.log 2>&1
        continue-on-error: true # æ•è·å¤±è´¥å¹¶å…è®¸åç»­æ­¥éª¤è¿è¡Œ
      # è·å–å½“å‰ PR ç¼–å·å¹¶è®¾ç½®ç¯å¢ƒå˜é‡
      - name: è·å– PR ç¼–å·
        run: echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
      # è‡ªåŠ¨ä¿®æ”¹ package.json çš„ç‰ˆæœ¬å·ã€åˆ é™¤å¼€å‘ã€å¯¹ç­‰ä¾èµ–
      - name: ä¿®è®¢ç‰ˆæœ¬å·
        run: npm run pr all
        if: success()
      # å‘å¸ƒåˆ° npm
      - name: å‘å¸ƒåˆ° npm
        run: npm run pub-beta
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        if: success()
      # åœ¨ PR ä¸Šå‘å¸ƒæ„å»ºå®Œæˆæˆ–å¤±è´¥ä¿¡æ¯
      - name: å‘å¸ƒè¯„è®º
        run: |
          if [ "${{ steps.build.outcome }}" = "failure" ]; then
            # æ•è·æ„å»ºå¤±è´¥æ—¥å¿—
            ERROR_MESSAGE=$(cat build.log || echo "æœªæ‰¾åˆ°è¯¦ç»†çš„æ„å»ºæ—¥å¿—ã€‚")
            # å‘å¸ƒæ„å»ºå¤±è´¥è¯„è®º
            gh pr comment ${{ env.PR_NUMBER }} --body $'âŒ æ„å»ºå¤±è´¥ï¼ä»¥ä¸‹æ˜¯é”™è¯¯æ—¥å¿—ï¼š\n\n<details>\n<summary>å±•å¼€æŸ¥çœ‹é”™è¯¯æ—¥å¿—</summary>\n\n```\n'"${ERROR_MESSAGE}"$'\n```\n\n</details>'
          else
            # æ„å»ºæˆåŠŸè¯„è®º
            INSTALL_COMMAND="pnpm install ${{ env.PKG_NAME }}@${{ env.PKG_VERSION }} -w"
            gh pr comment ${{ env.PR_NUMBER }} --body $'ğŸ‰ æ„å»ºå®Œæˆï¼æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…æ­¤ç‰ˆæœ¬ï¼š\n\n```\n'"${INSTALL_COMMAND}"$'\n```'
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE }}
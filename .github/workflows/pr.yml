name: PR

# ç›‘å¬ PR ç›¸å…³äº‹ä»¶
on:
  pull_request:
    # ç›‘å¬ PR è¢«æ‰“å¼€ã€é‡æ–°æ‰“å¼€å’Œæ¨é€äº‹ä»¶
    types: [opened, reopened, synchronize]

# èµ‹äºˆ release-please-action æƒé™
permissions:
  contents: write
  pull-requests: write
jobs:
  # è®¾ç½® release-please ä»»åŠ¡
  release-please:
    # è®¾ç½®ä»»åŠ¡è¿è¡Œç¯å¢ƒä¸º ubuntu-latest
    runs-on: ubuntu-latest
    steps:
      # æ£€å‡ºä»£ç 
      - uses: actions/checkout@v4
      # è®¾ç½® Node.js ç¯å¢ƒ
      - uses: actions/setup-node@v4
        with:
          # è®¾ç½® Node.js ç‰ˆæœ¬
          node-version: 20
          # è®¾ç½® npm æº
          registry-url: "https://registry.npmjs.org"
      # å®‰è£…ä¾èµ– ä¸å®‰è£…å¯¹ç­‰ä¾èµ–
      - run: npm install --config.auto-install-peers=false --ignore-scripts --omit=peer
      # æ„å»ºè¾“å‡º
      - run: npm run build
      # è·å–å½“å‰ PR ç¼–å·å¹¶è®¾ç½®ç¯å¢ƒå˜é‡
      - run: echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
      # è‡ªåŠ¨ä¿®æ”¹ package.json çš„ç‰ˆæœ¬å·ã€åˆ é™¤å¼€å‘ã€å¯¹ç­‰ä¾èµ–
      - run: npm run pr all
      # å‘å¸ƒåˆ° npm
      - run: npm run pub-beta
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      # åœ¨ PR ä¸Šå‘å¸ƒè¯„è®º
      - run: |
          INSTALL_COMMAND="npm install ${{ env.PKG_NAME }}@${{ env.PKG_VERSION }}"
          gh pr comment ${{ env.PR_NUMBER }} --body $'ğŸ‰ æ„å»ºå®Œæˆï¼æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…æ­¤ç‰ˆæœ¬ï¼š\n\n```\n'"${INSTALL_COMMAND}"$'\n```'
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE }}

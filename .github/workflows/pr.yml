name: PR

# ç›‘å¬ PR ç›¸å…³äº‹ä»¶
on:
  pull_request:
    # ç›‘å¬ PR è¢«æ‰“å¼€ã€é‡æ–°æ‰“å¼€å’Œæ¨é€äº‹ä»¶
    types: [opened, reopened, synchronize]

# èµ‹äºˆ release-please-action æƒé™
permissions:
  contents: write
  pull-requests: write
jobs:
  # è®¾ç½® release-please ä»»åŠ¡
  release-please:
    # è®¾ç½®ä»»åŠ¡è¿è¡Œç¯å¢ƒä¸º ubuntu-latest
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      # è®¾ç½® Node.js ç¯å¢ƒ
      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          # è®¾ç½® Node.js ç‰ˆæœ¬
          node-version: 20
          # è®¾ç½® npm æº
          registry-url: "https://registry.npmjs.org"
      # å®‰è£…ä¾èµ– ä¸å®‰è£…å¯¹ç­‰ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: npm install --config.auto-install-peers=false --ignore-scripts --omit=peer
      # æ„å»ºè¾“å‡º
      - name: æ„å»ºè¾“å‡º
        id: build
        run: npm run build > build.log 2>&1
        continue-on-error: true # æ•è·å¤±è´¥å¹¶å…è®¸åç»­æ­¥éª¤è¿è¡Œ
      # è·å–å½“å‰ PR ç¼–å·å¹¶è®¾ç½®ç¯å¢ƒå˜é‡
      - name: è·å– PR ç¼–å·
        run: echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
      # è‡ªåŠ¨ä¿®æ”¹ package.json çš„ç‰ˆæœ¬å·ã€åˆ é™¤å¼€å‘ã€å¯¹ç­‰ä¾èµ–
      - name: ä¿®è®¢ç‰ˆæœ¬å·
        run: npm run pr all
        if: success()
      # å‘å¸ƒåˆ° npm
      - name: å‘å¸ƒåˆ° npm
        run: npm run pub-beta
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        if: success()
      # åœ¨ PR ä¸Šå‘å¸ƒæ„å»ºå®Œæˆæˆ–å¤±è´¥ä¿¡æ¯
      - name: å‘å¸ƒè¯„è®º
        run: |
          # è·å–å½“å‰PRçš„æ‰€æœ‰è¯„è®ºï¼ˆæ­¤æ—¶åº”è¯¥æ˜¯ä¸€ä¸ªJSONæ ¼å¼çš„å­—ç¬¦ä¸²ï¼‰
          comments=$(gh pr view ${{ env.PR_NUMBER }} --json comments --jq '.comments')

          # æ‰“å°æ‰€æœ‰è¯„è®ºï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯åˆæ³•çš„JSONå­—ç¬¦ä¸²
          echo "$comments"

          # å°†è·å–çš„å­—ç¬¦ä¸²ååºåˆ—åŒ–ä¸ºJSONæ ¼å¼
          comment_data=$(echo "$comments" | jq 'fromjson')

          # å¦‚æœä»jsonè§£æå¤±è´¥ï¼Œé€€å‡º
          if [ $? -ne 0 ]; then
            echo "æ— æ³•è§£æè¯„è®ºæ•°æ®ä¸ºJSONæ ¼å¼ï¼Œé€€å‡ºï¼"
            exit 1
          fi

          # è·å–å½“å‰PRæ‰€æœ‰è¯„è®ºçš„IDå’Œå†…å®¹
          comment_data=$(echo "$comment_data" | jq -r '.[] | {id: .id, body: .body}')

          # æ„å»ºå¤±è´¥æˆ–æˆåŠŸçš„è¯„è®ºå†…å®¹
          if [ "${{ steps.build.outcome }}" = "failure" ]; then
            # æ•è·æ„å»ºå¤±è´¥æ—¥å¿—
            ERROR_MESSAGE=$(cat build.log || echo "æœªæ‰¾åˆ°è¯¦ç»†çš„æ„å»ºæ—¥å¿—ã€‚")
            comment_body=$'âŒ æ„å»ºå¤±è´¥ï¼ä»¥ä¸‹æ˜¯é”™è¯¯æ—¥å¿—ï¼š\n\n<details>\n<summary>å±•å¼€æŸ¥çœ‹é”™è¯¯æ—¥å¿—</summary>\n\n```\n'"${ERROR_MESSAGE}"$'\n```\n\n</details>'
          else
            INSTALL_COMMAND_1="pnpm rm ${{ env.PKG_NAME }} && pnpm install ${{ env.PKG_NAME }}@${{ env.PKG_VERSION }} -D"           
            INSTALL_COMMAND_2="pnpm install ${{ env.PKG_NAME }}@${{ env.PKG_VERSION }} -w"
            comment_body=$'ğŸ‰ æ„å»ºå®Œæˆï¼æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…æ­¤ç‰ˆæœ¬ï¼š\n\n```\n'"${INSTALL_COMMAND_1}"$'\n```\n\n```\n'"${INSTALL_COMMAND_2}"$'\n```'
          fi

          # å‘å¸ƒæ–°çš„è¯„è®º
          gh pr comment ${{ env.PR_NUMBER }} --body "$comment_body"

          # è·å–æ‰€æœ‰ç›®æ ‡è¯„è®ºçš„ID
          target_comment_ids=$(echo "$comment_data" | grep -E "æ„å»ºå®Œæˆ|æ„å»ºå¤±è´¥" | jq -r '.[].id')

          # å¦‚æœè¯„è®ºæ•°è¶³å¤Ÿå¤šä¸”æœ‰ç›®æ ‡è¯„è®ºï¼Œåˆ™åˆ é™¤å¤šä½™è¯„è®º
          comment_count=$(echo "$target_comment_ids" | wc -l)

          # å¦‚æœè¯„è®ºæ•°è¶…è¿‡3æ¡ï¼Œåˆ é™¤è¶…è¿‡çš„è¯„è®º
          if [ "$comment_count" -ge 3 ]; then
            comment_ids_to_delete=$(echo "$target_comment_ids" | tail -n +4) # è·å–è¶…è¿‡3æ¡è¯„è®ºçš„ID
            for id in $comment_ids_to_delete; do
              gh pr comment ${{ env.PR_NUMBER }} --delete --comment-id $id
            done
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE }}

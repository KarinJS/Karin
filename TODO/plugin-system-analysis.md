# æ’ä»¶ç³»ç»Ÿæºç ç»“æ„åˆ†æ

> åˆ†ææ—¥æœŸ: 2025-12-27
> ç›®æ ‡ç›®å½•: `packages/plugin/src`

## ğŸ“ ç›®å½•ç»“æ„

```
packages/plugin/src/
â”œâ”€â”€ index.ts              # ç»Ÿä¸€å…¥å£ï¼Œå¯¼å‡º pluginLoader å’Œå¼€å‘ API
â”œâ”€â”€ cache/                # è¿è¡Œæ—¶ç¼“å­˜ç®¡ç†
â”œâ”€â”€ config/               # karin.config ç±»å‹å®šä¹‰
â”œâ”€â”€ core/                 # æ ¸å¿ƒåŠ è½½é€»è¾‘
â”‚   â”œâ”€â”€ index.ts
â”‚   â”œâ”€â”€ metadata.ts       # å…ƒæ•°æ®è§£æ
â”‚   â”œâ”€â”€ load/             # åŠ è½½å™¨å®ç°
â”‚   â”‚   â”œâ”€â”€ core.ts       # PluginsLoader åŸºç±»
â”‚   â”‚   â”œâ”€â”€ npm.ts        # NPM åŒ…åŠ è½½å™¨
â”‚   â”‚   â”œâ”€â”€ git.ts        # Git ä»“åº“åŠ è½½å™¨
â”‚   â”‚   â”œâ”€â”€ dev.ts        # å¼€å‘ç›®å½•åŠ è½½å™¨
â”‚   â”‚   â””â”€â”€ apps.ts       # Apps ç›®å½•åŠ è½½å™¨
â”‚   â””â”€â”€ utils/            # å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ env.ts        # ç¯å¢ƒå˜é‡å¤„ç†
â”‚       â”œâ”€â”€ status.ts     # çŠ¶æ€æ‰“å°
â”‚       â””â”€â”€ engines.ts    # å¼•æ“ç‰ˆæœ¬æ£€æŸ¥
â”œâ”€â”€ create/               # æ’ä»¶å¼€å‘ DSL
â”‚   â”œâ”€â”€ index.ts
â”‚   â”œâ”€â”€ accept.ts         # äº‹ä»¶æ¥æ”¶å™¨
â”‚   â”œâ”€â”€ button.ts         # æŒ‰é’®ç»„ä»¶
â”‚   â”œâ”€â”€ command.ts        # æŒ‡ä»¤å®šä¹‰
â”‚   â”œâ”€â”€ handler.ts        # å¤„ç†å™¨
â”‚   â”œâ”€â”€ task.ts           # å®šæ—¶ä»»åŠ¡
â”‚   â”œâ”€â”€ class.ts          # Plugin ç±»
â”‚   â””â”€â”€ context.ts        # ä¸Šä¸‹æ–‡ç®¡ç†
â”œâ”€â”€ hmr/                  # çƒ­é‡è½½ï¼ˆâš ï¸ æŸåï¼‰
â”‚   â”œâ”€â”€ index.ts          # HMRManager å¯¼å‡º
â”‚   â”œâ”€â”€ hmr.ts            # é‡è½½é€»è¾‘
â”‚   â”œâ”€â”€ watcher.ts        # æ–‡ä»¶ç›‘å¬
â”‚   â”œâ”€â”€ core.ts           # HMR æ ¸å¿ƒ
â”‚   â””â”€â”€ internal.ts       # å†…éƒ¨å·¥å…·
â”œâ”€â”€ marketplace/          # æ’ä»¶å¸‚åœº
â””â”€â”€ package/              # åŒ…å‘ç°ä¸æ‰«æ
```

## ğŸ”„ å½“å‰åŠ è½½æµç¨‹

```
pluginLoader.run()
    â”‚
    â”œâ”€â”€ PluginsLoaderNpm.init()    â”€â”
    â”œâ”€â”€ PluginsLoaderGit.init()     â”‚  å¹¶è¡Œæ‰§è¡Œ
    â”œâ”€â”€ PluginsLoaderDev.init()     â”‚
    â””â”€â”€ PluginsLoaderApps.init()   â”€â”˜
                â”‚
                â–¼
        plugin:load:done äº‹ä»¶
                â”‚
                â–¼
        pluginLoader.sort() æ’åº
                â”‚
                â–¼
        æ‰“å°çŠ¶æ€æŠ¥å‘Š
```

## ğŸ§© æ ¸å¿ƒæ¨¡å—èŒè´£

### 1. `core/load/core.ts` - PluginsLoader åŸºç±»

| æ–¹æ³• | èŒè´£ |
|------|------|
| `readPkg()` | è¯»å– package.json |
| `getConfig()` | è·å– karin.config é…ç½® |
| `getEntry()` | è§£æå…¥å£æ–‡ä»¶åˆ—è¡¨ |
| `loadMain()` | åŠ è½½ main æ–‡ä»¶å¹¶æ‰§è¡Œ `KARIN_PLUGIN_INIT` |
| `loadEntry()` | æ‰¹é‡åŠ è½½å…¥å£æ–‡ä»¶å¹¶æ³¨å†Œæ¨¡å— |
| `checkVersion()` | å¼•æ“ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥ |
| `setup()` / `setupV1()` | åˆå§‹åŒ–æ’ä»¶ç¯å¢ƒï¼ˆåˆ›å»ºç›®å½•ã€è®¾ç½®ç¯å¢ƒå˜é‡ï¼‰ |
| `addCache()` | æ·»åŠ åˆ°ç¼“å­˜ç³»ç»Ÿ |

### 2. `cache/` - ç¼“å­˜ç³»ç»Ÿ

- `pluginCache.instances` - å­˜å‚¨å·²æ³¨å†Œçš„æ’ä»¶å®ä¾‹ï¼ˆæŒ‰ç±»å‹åˆ†ç±»ï¼šaccept/button/command/handlerï¼‰
- `pluginCache.package` - å­˜å‚¨åŒ…å…ƒä¿¡æ¯å’Œæ–‡ä»¶æ˜ å°„
- `pluginCache.public` - å­˜å‚¨æ’ä»¶å…¬å¼€é…ç½®
- `pluginCache.missingDeps` - è®°å½•ç¼ºå¤±ä¾èµ–

### 3. `create/` - å¼€å‘ DSL

```typescript
// å‡½æ•°å¼ API
command('name', callback, options)
accept('event', callback, options)
handler('key', callback, options)
task('cron', callback, options)
button('id', callback, options)

// ç±»å¼ API
class MyPlugin extends Plugin { ... }
```

### 4. `hmr/` - çƒ­é‡è½½ï¼ˆæŸåï¼‰

**é—®é¢˜**: ä¾èµ–ä¸å­˜åœ¨çš„ `../registry/registry` æ¨¡å—

è®¾è®¡æ„å›¾:

- `reloadApp(file)` - å•æ–‡ä»¶çƒ­é‡è½½
- `reloadPackage(pkgName)` - æ•´åŒ…çƒ­é‡è½½
- `hmrProduction(list)` - ç”Ÿäº§ç¯å¢ƒæ–‡ä»¶ç›‘å¬

## âš ï¸ å·²çŸ¥é—®é¢˜

### 1. HMR æ¨¡å—æŸå

```typescript
// hmr/hmr.ts å’Œ hmr/watcher.ts
import { registry } from '../registry/registry'  // âŒ ç›®å½•ä¸å­˜åœ¨
```

### 2. TODO åˆ—è¡¨ï¼ˆæ¥è‡ª index.tsï¼‰

```typescript
// TODO: ç¯å¢ƒå˜é‡
// TODO: çƒ­ç‚¹ç¼“å­˜æ·»åŠ é…ç½®æ–‡ä»¶
// TODO: å¯¼å‡ºç±»å‹ã€éƒ¨åˆ†API
// TODO: æ›´æ–°ã€ç¦ç”¨ã€å¯ç”¨ã€å¸è½½ç­‰åŠŸèƒ½
// TODO: hmr hot APIå®ç°
```

### 3. åŠ è½½å™¨åˆ†æ•£

- 4 ä¸ªåŠ è½½å™¨ç±»ï¼ˆnpm/git/dev/appsï¼‰å„è‡ªç‹¬ç«‹åˆå§‹åŒ–
- æ²¡æœ‰ç»Ÿä¸€çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†
- æ’åºé€»è¾‘åœ¨åŠ è½½å®Œæˆåæ‰æ‰§è¡Œ

### 4. æ³¨å†Œé€»è¾‘åˆ†æ•£

- `create/class.ts` ä¸­æœ‰ `registerModule`
- `hmr/` ä¸­å¼•ç”¨äº†ä¸å­˜åœ¨çš„ `registry`
- ç¼ºå°‘ç»Ÿä¸€çš„æ³¨å†Œ/æ³¨é”€å…¥å£

## ğŸ“Š æ¨¡å—ä¾èµ–å…³ç³»

```
index.ts
    â”‚
    â”œâ”€â”€ cache/
    â”‚     â””â”€â”€ pluginCache (å…¨å±€çŠ¶æ€)
    â”‚
    â”œâ”€â”€ core/
    â”‚     â”œâ”€â”€ load/* (åŠ è½½å™¨)
    â”‚     â”‚     â””â”€â”€ ä¾èµ– cache/
    â”‚     â””â”€â”€ utils/* (å·¥å…·)
    â”‚
    â”œâ”€â”€ create/
    â”‚     â”œâ”€â”€ DSL å‡½æ•°
    â”‚     â””â”€â”€ class.ts â†’ registerModule()
    â”‚           â””â”€â”€ ä¾èµ– cache/
    â”‚
    â”œâ”€â”€ hmr/ (æŸå)
    â”‚     â””â”€â”€ ä¾èµ–ä¸å­˜åœ¨çš„ registry/
    â”‚
    â”œâ”€â”€ config/
    â”‚     â””â”€â”€ ç±»å‹å®šä¹‰
    â”‚
    â””â”€â”€ package/
          â””â”€â”€ packageFinder
```

## ğŸ”¢ ä»£ç é‡ç»Ÿè®¡ï¼ˆä¼°ç®—ï¼‰

| æ¨¡å— | æ–‡ä»¶æ•° | ä¸»è¦å¤æ‚åº¦ |
|------|--------|-----------|
| core/load | 5 | é«˜ - å¤šä¸ªåŠ è½½å™¨ç±» |
| create | 7 | ä¸­ - DSL å®ç° |
| cache | ~3 | ä¸­ - å¤šç§ç¼“å­˜ç±»å‹ |
| hmr | 5 | é«˜ - ä½†å·²æŸå |
| config | ~2 | ä½ - ç±»å‹å®šä¹‰ |
| package | ~2 | ä¸­ |

## ğŸ’¡ å°ç»“

å½“å‰æ’ä»¶ç³»ç»Ÿçš„æ ¸å¿ƒé—®é¢˜ï¼š

1. **HMR å®Œå…¨ä¸å¯ç”¨** - ä¾èµ–æ¨¡å—ä¸¢å¤±
2. **ç¼ºå°‘ç»Ÿä¸€çš„ Registry** - æ³¨å†Œ/æ³¨é”€é€»è¾‘åˆ†æ•£
3. **4 ä¸ªåŠ è½½å™¨å„è‡ªä¸ºæ”¿** - æ²¡æœ‰ç»Ÿä¸€åè°ƒ
4. **ç”Ÿå‘½å‘¨æœŸä¸å®Œæ•´** - åªæœ‰åŠ è½½ï¼Œæ²¡æœ‰å¸è½½/æ›´æ–°
